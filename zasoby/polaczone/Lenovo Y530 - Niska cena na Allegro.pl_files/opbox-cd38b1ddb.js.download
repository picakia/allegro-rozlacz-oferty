var attach=function(e){function t(){t=function(){return e};var e={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function l(e,t,n,r){var i=t&&t.prototype instanceof f?t:f,a=Object.create(i.prototype),s=new S(r||[]);return o(a,"_invoke",{value:E(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var h={};function f(){}function p(){}function v(){}var g={};u(g,a,(function(){return this}));var m=Object.getPrototypeOf,b=m&&m(m(I([])));b&&b!==n&&r.call(b,a)&&(g=b);var y=v.prototype=f.prototype=Object.create(g);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function C(e,t){function n(o,i,a,s){var c=d(e[o],e,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(l).then((function(e){u.value=e,a(u)}),(function(e){return n("throw",e,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function E(e,t,n){var r="suspendedStart";return function(o,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw i;return{value:void 0,done:!0}}for(n.method=o,n.arg=i;;){var a=n.delegate;if(a){var s=k(a,n);if(s){if(s===h)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=d(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===h)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}function k(e,t){var n=t.method,r=e.iterator[n];if(void 0===r)return t.delegate=null,"throw"===n&&e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method)||"return"!==n&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+n+"' method")),h;var o=d(r,e.iterator,t.arg);if("throw"===o.type)return t.method="throw",t.arg=o.arg,t.delegate=null,h;var i=o.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function I(e){if(e||""===e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}throw new TypeError(typeof e+" is not iterable")}return p.prototype=v,o(y,"constructor",{value:v,configurable:!0}),o(v,"constructor",{value:p,configurable:!0}),p.displayName=u(v,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,u(e,c,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},w(C.prototype),u(C.prototype,s,(function(){return this})),e.AsyncIterator=C,e.async=function(t,n,r,o,i){void 0===i&&(i=Promise);var a=new C(l(t,n,r,o),i);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},w(y),u(y,c,"Generator"),u(y,a,(function(){return this})),u(y,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},e.values=I,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(P),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var s=r.call(i,"catchLoc"),c=r.call(i,"finallyLoc");if(s&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,h):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;P(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),h}},e}function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,k(r.key),r)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t,n){return(t=k(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function u(e,t){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},u(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,n){return d=l()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&u(o,n.prototype),o},d.apply(null,arguments)}function h(e){var t="function"==typeof Map?new Map:void 0;return h=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return d(e,arguments,c(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),u(r,e)},h(e)}function f(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function p(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function v(e,t){return m(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],c=!0,u=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(u)throw o}}return s}}(e,t)||y(e,t)||C()}function g(e){return function(e){if(Array.isArray(e))return w(e)}(e)||b(e)||y(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e){if(Array.isArray(e))return e}function b(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function y(e,t){if(e){if("string"==typeof e)return w(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?w(e,t):void 0}}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function C(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function E(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=y(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function k(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var x="metrum-",P="/metrum/",S="data-opbox-fragment-pathname",I=Object.assign,O=Object.values,A=Object.keys,N=Object.entries,j=Array.from;function R(e){return[].slice.call(e)}var T=JSON.parse,M=JSON.stringify;function V(e){return Array.isArray(e)}function L(e){return n(e)}function D(e){return"object"===L(e)&&!V(e)&&null!==e}function B(e){return"string"===L(e)}function W(e){return"undefined"===L(e)}function F(e){return"function"===L(e)}function U(e){return null===e||"object"!==L(e)||0===A(e).length}function z(e,t,n){return e?j(e.querySelectorAll(t),n):[]}function H(e,t){return e?e.querySelector(t):null}function _(e,t){return e.hasAttribute(t)}function q(e,t){return e?e.getAttribute(t):null}function Q(e){return q(e,"data-prototype-id")}function G(e){return q(e,"data-box-id")}function Y(e){return q(e,"data-box-name")}function J(e){return q(e,"data-civ")}function K(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];return I.apply(void 0,[e.createElement(t)].concat(r))}function X(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"").includes(P)}function $(e){return B(e)?e.split(P)[1].split("/")[0].replace(x,""):""}function Z(){}function ee(e,t,n){var r;return function(){for(var o=arguments.length,i=new Array(o),a=0;a<o;a++)i[a]=arguments[a];var s=this,c=n&&!r;return clearTimeout(r),r=setTimeout((function(){r=null,n||e.apply(s,i)}),t),c&&e.apply(s,i),r}}function te(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new CustomEvent(t,Object.assign({bubbles:!1,cancelable:!0},n));e.dispatchEvent(r)}function ne(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];if(0===r.length)return e=t;var i=r[0],a=r.slice(1);return(e="object"!==L(e)?{}:e)[i]=ne.apply(void 0,[e[i],t].concat(g(a))),e}function re(e,t){return A(e).reduce((function(n,r){var o=e[r],i="object"===L(o)?re(o,t):o;return n[t.find((function(e){return r.toLowerCase()===e.toLowerCase()}))||r]=i,n}),{})}function oe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!1};A(e).forEach((function(n){Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])&&delete e[n]}))}var ie=/Version\/[\d.]+.*Safari/,ae=/iPhone|iPad|iPod|Android/i;var se=function(e){return function(t,n){return Object.assign(Object.assign({},t),e(n))}},ce=function(e,t,n,r){return e.addEventListener(t,n,{capture:r})},ue=function(e,t,n){return e.removeEventListener(t,n)},le=function(){return Date.now()};function de(e){return"noModule"in K(e.document,"script")}function he(e){setTimeout(e,0)}function fe(e,t){"loading"===e.readyState?ce(e,"DOMContentLoaded",t):t()}function pe(e){return e.textContent}var ve="Request has been aborted",ge=function(e){return e>=200&&e<=204},me=function(e,t,n,r){var o=e.status,i=e.response,a=e.responseType,s=t(o),c=function(e){return e.split("\n").reduce((function(e,t){var n=t.indexOf(":"),r=t.substr(0,n).trim().toLowerCase(),o=t.substr(n+1).trim();return r&&(e[r]=e[r]?"".concat(e[r],", ").concat(o):o),e}),{})}(e.getAllResponseHeaders()),u={};if("blob"===a)u=i;else{var l=e.responseText;try{u=T(l)}catch(e){u=l}}s?n({status:o,data:u,headers:c}):r({status:o,data:u,message:"Request failed with status code ".concat(o),headers:c})},be=function(e,t,n){e.send(function(e,t){return["POST","PUT","PATCH"].includes(e)?"object"!==L(t)||t instanceof Blob||t instanceof FormData?t:M(t):null}(t,n))},ye=function(){var e=null,t=function(t,n,r,o){var i=o.headers,a=void 0===i?{}:i,s=o.validateStatus,c=void 0===s?ge:s,u=o.withCredentials,l=void 0!==u&&u,d=o.cancelLast,h=void 0!==d&&d,f=o.onUploadProgress,p=o.responseType,v=void 0===p?"":p,g=o.signal;if(h&&(console.log("You are using deprecated option that will be removed in next major version of opbox-web-browser. Consider using signal option instead"),null!==e&&e.abort()),g&&g.aborted)return Promise.reject(new Error(ve));var m=function(e,t,n,r,o,i){var a=new XMLHttpRequest;return a.open(e,t,!0),A(n).forEach((function(e){a.setRequestHeader(e,n[e])})),a.withCredentials=r,a.responseType=i,a.upload&&o&&ce(a.upload,"progress",o),a}(t,n,a,l,f,v);e=m;var b=function(e,t,n){return new Promise((function(r,o){function i(){me(e,t,r,o),c()}function a(){me(e,t,r,o),c()}function s(){e.abort(),o(new Error("Request has been aborted")),c()}function c(){ue(e,"load",i),ue(e,"error",a),n&&ue(n,"abort",s)}ce(e,"load",i),ce(e,"error",a),n&&ce(n,"abort",s)}))}(m,c,g).finally((function(){e=null}));return be(m,t,r),b};return{request:t,get:function(e){return t("GET",e,{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})},post:function(e,n,r){return t("POST",e,n,r)},put:function(e,n,r){return t("PUT",e,n,r)},patch:function(e,n,r){return t("PATCH",e,n,r)},delete:function(e){return t("DELETE",e,{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}}},we="opbox",Ce=function(e){return e[we]||{}},Ee=function(){function e(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).targetWindow;o(this,e),this.targetWindow=t}return a(e,[{key:"document",get:function(){return this.targetWindow.document}}]),e}(),ke=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}(i,e);var t,n,r=(t=i,n=l(),function(){var e,r=c(t);if(n){var o=c(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return p(this,e)});function i(e){var t;return o(this,i),(t=r.call(this,e)).message=e,t.name="PageRenderingError",t}return a(i)}(h(Error)),xe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.data,r=t.headers;o(this,e),this.data=n,this.headers=r}return a(e,[{key:"valid",get:function(){return D(this.data)}}]),e}(),Pe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,e),this.dataSources=t}return a(e,[{key:"resolve",value:function(e,t){var n=e.value;if("DATA_SOURCE"===e.type){var r=this.dataSources[n];return Object.assign(Object.assign({},r&&r.data&&s({},t,r.data)),r&&!U(r.metadata)&&s({},"".concat(t,".$meta"),r.metadata))}return s({},t,n)}},{key:"resolveAll",value:function(e){var t=this;return A(e).reduce((function(n,r){return Object.assign(Object.assign({},n),t.resolve(e[r],r))}),{})}}]),e}(),Se=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.boxes,r=void 0===n?{}:n,i=t.boxNameToIdMap,a=void 0===i?{}:i,s=t.dataSources,c=void 0===s?{}:s,u=t.meta,l=void 0===u?{}:u;o(this,e),this.boxes=r,this.boxNameToIdMap=a,this.dataSources=c,this.meta=l,this.parameterResolver=new Pe(c)}return a(e,[{key:"resolved",get:function(){return{boxes:this.resolvedBoxes,boxNameToIdMap:this.boxNameToIdMap,dataSources:this.dataSources,meta:this.meta}}},{key:"resolvedBoxes",get:function(){var e=this,t=this.pageProperties;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,r={};return A(e).forEach((function(o){r[o]=t.call(n,e[o],o,e)})),r}(this.boxes,(function(n){var r=A(n).reduce((function(t,r){var o=e.parameterResolver.resolve(n[r],r);return I(t,o)}),{});return I(r,t)}))}},{key:"pageProperties",get:function(){var e={};for(var t in this.meta)0===t.indexOf("$page.")&&(e[t]=this.meta[t]);return e}}]),e}();function Ie(e){var t=e.href,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new URL(t);return r.search=function(e,t){var n=new URLSearchParams(e.search);return N(t).map((function(e){var t=v(e,2),r=t[0],o=t[1];return V(o)?(n.delete(r),o.forEach((function(e){return n.append(r,e)}))):n.set(r,o),n})),n}(r,n).toString(),r.toString()}var Oe="application/vnd.opbox-web.subtree+json";function Ae(e){return e>=200&&e<300||502===e}var Ne=function(){function e(t){var n=this,r=t.targetWindow,i=void 0===r?window:r,a=t.config,s=void 0===a?{}:a,c=t.httpClient,u=t.reportError,l=t.fragmentRenderCallback,d=t.boxRenderCallback;o(this,e),this.updateViewId=function(e){n.viewId=e},this.renderSubtree=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.boxId,r=e.additionalQueryParameters,o=void 0===r?{}:r,i=e.isPlaceholder,a=void 0!==i&&i;return n.targetWindow.console.warn("Warning: renderSubtree method is deprecated and will be removed soon. Use render.box method instead."),n.renderBox({boxId:t,additionalQueryParameters:o,isPlaceholder:a})},this.httpClient=c,this.reportError=u,this.targetWindow=i,this.fragmentRenderCallback=l,this.boxRenderCallback=d,this.render={box:this.renderBox.bind(this),fragment:this.renderFragment.bind(this)},this.viewId=s.viewId,this.getPageDataAbortController=new AbortController}return a(e,[{key:"getPageData",value:function(e){this.getPageDataAbortController.abort(),this.getPageDataAbortController=new AbortController;var t={headers:{Accept:"application/vnd.opbox-web.v2+json"},validateStatus:Ae,signal:this.getPageDataAbortController.signal};return this.httpClient.get(e,t).then((function(e){var t=new xe(e);if(!t.valid)throw new ke("Opbox response is invalid.");return new Se(t.data)}))}},{key:"handleError",value:function(e){return this.reportError(new Error(e)),Promise.reject(e)}},{key:"renderBox",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.boxId,r=t.additionalQueryParameters,o=void 0===r?{}:r,i=t.isPlaceholder,a=void 0!==i&&i;return n?this.httpClient.get(Ie(this.targetWindow.location,o),{headers:{Accept:Oe,"x-box-id":n,"x-view-id":this.viewId},validateStatus:Ae}).then((function(t){var r=t.data;return e.boxRenderCallback({boxId:n,data:r,isPlaceholder:a})})):this.handleError("Missing 'boxId' property!")}},{key:"renderFragment",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.pathname,r=t.additionalQueryParameters,o=void 0===r?{}:r;if(!n)return this.handleError("Missing 'pathname' property!");if(!function(e){return!!e.match(new RegExp("^(\\/[a-zA-Z0-9\\-]+)*\\/{0,1}$"))}(n))return this.handleError("Invalid 'pathname' property!");var i=this.targetWindow.location,a=i.protocol,s=i.host,c=new URL("".concat(a,"//").concat(s).concat(n)).href;return this.httpClient.get(Ie({href:c},o),{headers:{Accept:Oe,"x-view-id":this.viewId},validateStatus:Ae}).then((function(t){var r=t.data;return e.fragmentRenderCallback({pathname:n,data:r})}))}},{key:"createAPI",value:function(){return{renderSubtree:this.renderSubtree,render:this.render}}}]),e}(),je=function(){function e(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).meta,n=void 0===t?{}:t,r=arguments.length>1?arguments[1]:void 0;o(this,e),this.appContext=r,this.meta=n}return a(e,[{key:"updateMetaRobots",value:function(){var e=H(this.appContext.document,'head meta[name="robots"]');e&&this.meta&&e.setAttribute("content",[this.meta.noindexCondition?"noindex":"index",this.meta.nofollowCondition?"nofollow":"follow"].join(", "))}},{key:"render",value:function(){this.updateMetaRobots()}}]),e}(),Re=function(){function e(t){var n=this,r=t.appContext,i=t.analytics,a=t.debugData,s=t.updateViewIdCallback,c=t.updateComponentCallback,u=void 0===c?Z:c,l=t.beforeUpdateComponentCallback,d=void 0===l?Z:l;o(this,e),this.registerListener=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Z,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z;if(n.rawData.boxes[e]){var o=n.rawData.resolved.boxes[e];setTimeout((function(){t(o)}),0)}n.listeners[e]={onChange:t,onProgress:r}},this.appContext=r,this.rawData=new Se,this.debugData=a,this.listeners={},this.analytics=i,this.updateViewIdCallback=s,this.updateComponentCallback=u,this.beforeUpdateComponentCallback=d}return a(e,[{key:"triggerChangeListener",value:function(e){var t=this;this.rawData=e;var n=this.rawData.resolved,r=n.boxes,o=n.boxNameToIdMap,i=n.meta,a=i.defaultCustomParams,s=i.viewId;this.analytics&&this.analytics.updateCustomParams(a,s),this.updateViewIdCallback&&this.updateViewIdCallback(s),N(r).forEach((function(e){var n=v(e,2),r=n[0],o=n[1];W(o)||t.updateComponentCallback(r,o)})),A(o).forEach((function(e){var n=r[o[e]];if(!W(n)){var i=t.listeners[e];i&&F(i.onChange)&&setTimeout((function(){return i.onChange(n)}),0)}})),new je({meta:i},this.appContext).render(),this.debugData&&this.debugData.onRawDataChange(this.rawData)}},{key:"triggerProgressListener",value:function(){var e=this;this.beforeUpdateComponentCallback(),A(this.listeners).forEach((function(t){var n=e.listeners[t];n&&F(n.onProgress)&&setTimeout((function(){return n.onProgress()}),0)}))}}]),e}(),Te=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self,{exports:{}});Te.exports=function(){function e(e){return e instanceof Object&&e.constructor===Object}function t(n,r){var o=n,i=r;e(n)||(o={}),e(r)||(i={});var a=Object.keys(o),s=Object.keys(i),c={};return a.forEach((function(n){-1!==s.indexOf(n)?null===o[n]?c[n]=i[n]:e(o[n])&&e(i[n])?c[n]=t(o[n],i[n]):c[n]=i[n]:c[n]=o[n]})),s.forEach((function(e){-1===a.indexOf(e)&&(c[e]=i[e])})),c}function n(n){var r=n;e(n)||(r={});for(var o=arguments.length,i=new Array(o>1?o-1:0),a=1;a<o;a++)i[a-1]=arguments[a];return i.forEach((function(n){e(n)&&(r=t(r,n))})),r}return n}();var Me=Te.exports,Ve=new WeakMap,Le=new WeakMap,De=new WeakMap,Be="data-analytics-enabled",We=function(e){return z(e,"[".concat(Be,"]"))},Fe=function(e){var t=z(e,"[".concat("data-analytics-proxied","]")).reduce((function(e,t){var n,r=We(t).filter((function(t){return!e.includes(t)}));return r.length?(n=r,e.concat(n)):e}),[]);return We(e).filter((function(e){return!t.includes(e)}))},Ue=function(e){return Le.has(e)},ze=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(e&&!Ue(e)){var r=(parseInt(De.get(e),10)||0)+t;r>=n&&(Le.set(e,!0),te(e,"boxView",{bubbles:!0})),De.set(e,r)}},He=function(e,t,n,r){var o={lowerValue:e,higherValue:t,viewportDimension:n,overrideLength:r};return Ve.has(o)||Ve.set(o,e>0?e<n?t<n?t-e:n-e:0:t<0?0:t<n?t:e<=0&&t>=n?n:r),Ve.get(o)},_e="data-analytics-tags",qe="data-item",Qe="light",Ge=function(e){return e.replace(/^([A-Z])|[\s|_-](\w)/g,(function(e,t,n){return n?n.toUpperCase():t.toLowerCase()}))},Ye=function(e){for(var t=e.contextNode,n=e.stringParamCustomPrefix,r=e.jsonParamCustomPrefix,o=e.reportError,i=void 0===o?function(){}:o,a={},s=0;s<t.attributes.length;s+=1){var c=t.attributes[s];if(n&&c.name.startsWith(n)){var u=c.name.replace(n,"");a[Ge(u)]=c.value}if(r&&c.name.startsWith(r)){var l=c.name.replace(r,"");try{a[Ge(l)]=T(c.value)}catch(e){i(new Error('An error "'.concat(e.message,'" occurred while extracting custom parameters from attributes')))}}}return a},Je=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;return t?Me(e,{renderedColorScheme:arguments.length>2?arguments[2]:void 0},{_opbox:{viewId:t}}):e},Ke=function(e){var t=e.contextNode,n=e.customParams,r=void 0===n?{}:n,o=e.reportError,i=Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-view-opbox-custom-"}),a=A(i).length?{_opbox:i}:{};return Me(Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-view-custom-",jsonParamCustomPrefix:"data-analytics-view-json-custom-",reportError:o}),a,r)},Xe=function(e){var t=e.contextNode,n=e.coordinates,r=void 0===n?{}:n,o=e.destinationUrl,i=void 0===o?"":o,a=e.customParams,s=void 0===a?{}:a,c=e.isNewTab,u=c?{isNewTab:c}:{},l=Object.assign(Object.assign(Object.assign({},Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-click-opbox-custom-"})),{},{destinationUrl:i},u),r);return Me(Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-click-custom-",jsonParamCustomPrefix:"data-analytics-click-json-custom-"}),{_opbox:l},s)},$e=function(e){var t=e.contextNode,n=e.customParams,r=void 0===n?{}:n,o=Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-interaction-custom-",jsonParamCustomPrefix:"data-analytics-interaction-json-custom-"}),i=Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-interaction-opbox-custom-"}),a=A(i).length?{_opbox:i}:{};return Me(o,a,r)},Ze=function(e){var t=e.closest("[".concat(_e,"]"));if(!t)return[];var n,r,o,i,a=!!t.closest("[".concat(qe,"]"))?function(e){var t=e&&e.closest("[".concat("data-box-name","][").concat(_e,"]"));return t&&q(t,_e)||""}(t):"",s=q(t,_e)||"";return n=s,r=a.split(","),o=n.split(","),(i=r.concat(o)).filter((function(e,t){return e&&i.indexOf(e)===t}))},et=function(e,t){return t&&e.matchMedia("(prefers-color-scheme: dark)").matches?"dark":Qe},tt=function(e,t,n,r){return ce(e,t,n,r),function(){ue(e,t,n)}},nt=function(){function e(t){var n=this,r=t.targetWindow,i=t.config,a=t.cookieMonsterClient,s=t.boxViewsMarker,c=t.reportError;o(this,e),this.sendPingEvent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={category:"Engagement",label:"ping",customParams:{et:e.engagementTime,sb:e.scrollBottom,ph:e.pageHeight}};n.cookieMonsterClient.send("event",t),n.callEventCallbacks(t)},this.detectAdblock=function(){var e=n.document,t=K(e,"div",{innerHTML:"&nbsp;",className:"adsbox"});e.body.appendChild(t),n.targetWindow.setTimeout((function(){var r=0!==t.offsetHeight;n.cookieMonsterClient.send("event",{category:"clearPV",action:r,customParams:n.defaultCustomParams.ev}),e.body.removeChild(t)}),100)},this.handleClick=function(e){n.handleBoxInteraction(e),n.handleLinkClick(e)},this.handleLinkClick=function(e){if(F(e.target.closest))if(n.shouldHandleBoxInteraction(e))n.handleBoxInteraction(e);else{var t=e.target.closest("a");if(t&&_(t,"data-analytics-clickable")){var r=q(t,"data-analytics-click-label")||"",o=q(t,"data-analytics-click-value")||pe(t).trim(),i="_blank"===q(t,"target"),a=q(t,"href"),s=e.pageX?{pageX:e.pageX,pageY:e.pageY}:{};"click"!==e.type||0!==e.button?"contextmenu"!==e.type?"mousedown"===e.type&&1===e.button&&n.sendClickEvent({contextNode:t,label:r,value:o,customParams:Xe({contextNode:t,coordinates:s,destinationUrl:a,isNewTab:!0})}):n.sendContextmenuEvent({contextNode:t,label:r,value:o,customParams:Xe({contextNode:t,coordinates:s,destinationUrl:a})}):n.sendClickEvent({contextNode:t,label:r,value:o,customParams:Xe({contextNode:t,coordinates:s,destinationUrl:a,isNewTab:i||e.metaKey||e.ctrlKey})})}}},this.handleChange=function(e){var t=e.target;if("select-one"===t.type&&t&&_(t,"data-analytics-selectable")){var r=t.options[t.selectedIndex].value,o=Ye({contextNode:t,stringParamCustomPrefix:"data-analytics-select-custom-"});n.sendEvent({contextNode:t,action:"change",value:r,customParams:o})}},this.handleSubmit=function(e){var t=e.target;if(t&&"FORM"===t.nodeName&&_(t,"data-analytics-submittable")){var r=q(t,"action"),o=j(t.elements).filter((function(e){return e.name})).map((function(e){return{name:e.name,value:e.value}})).sort((function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())})).map((function(e){return"".concat(e.name,"=").concat(e.value)})).join("&"),i=(o=o?"?".concat(o):"")?r+o:r;i=encodeURI(i),n.sendFormSubmitEvent({contextNode:t,value:i,label:"submitForm"})}},this.handleBoxView=function(e){var t=e.target;if(t&&_(t,"data-analytics-enabled")&&!j(t.childNodes).some((function(e){return e.classList&&e.classList.contains("opbox-fragment")}))){var r=q(t,"data-analytics-view-value")||"",o=q(t,"data-analytics-view-label")||"",i=Ke({contextNode:t,reportError:n.reportError});if(t.firstChild&&t.firstChild.nodeType===Node.ELEMENT_NODE&&(i=Object.assign(Object.assign({},i),Ye({contextNode:t.firstChild,stringParamCustomPrefix:"data-analytics-view-custom-"}))),_(t,qe))return n.markParentBoxAsVisible(t),void n.sendItemViewEvent({contextNode:t,label:o,value:r,customParams:i});i=Object.assign(Object.assign({},i),function(e){if(!e)return{};var t=q(e,"data-analytics-box-view-custom-params");if(!t)return{};var n={};try{n=T(decodeURIComponent(t))}catch(e){console.log(e)}return n}(t)),n.sendBoxViewEvent({contextNode:t,value:r,customParams:i})}},this.setFragmentAnalyticsContext=function(e,t){return n.fragmentCustomParams.set(e,t)},this.deleteFragmentAnalyticsContext=function(e){return n.fragmentCustomParams.delete(e)};var u=i.cookieMonster,l=void 0===u?{}:u,d=l.account,h=l.isEngagementMeasuringEnabled,f=l.defaultCustomParams,p=void 0===f?{}:f,v=i.isDarkModeEnabled,g=i.viewId;this.targetWindow=r,this.document=r.document,this.account=d,this.isEngagementMeasuringEnabled=h,this.cookieMonsterClient=a,this.boxViewsMarker=s,this.reportError=c,this.defaultCustomParams=p,this.fragmentCustomParams=new WeakMap,this.isDarkModeEnabled=v,this.viewId=g,this.eventCallbacks=[];var m=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).navigator,t=(void 0===e?{}:e).userAgent;return void 0===t?"":t}(r);this.isMobile=function(e){return!!e.match(ae)}(m),this.isSafari=function(e){return!!e.match(ie)}(m),this.isFirefox=function(e){return e.toLowerCase().includes("firefox")}(m)}return a(e,[{key:"initialize",value:function(){var e=this;if(this.account){this.cookieMonsterClient.initialize(),this.isEngagementMeasuringEnabled&&Promise.resolve().then((function(){return xn})).then((function(t){(0,t.attachEngagementObserver)({targetWindow:e.targetWindow,onCycleComplete:e.sendPingEvent})}));var t=this.document;this.eventHandlers=[tt(t,"change",this.handleChange),tt(t,"click",this.handleClick,!0),tt(t,"mousedown",this.handleLinkClick),tt(t,"submit",this.handleSubmit),tt(t,"contextmenu",this.handleClick),tt(t,"boxView",this.handleBoxView),tt(this.targetWindow,"DOMContentLoaded",this.detectAdblock)]}}},{key:"teardown",value:function(){this.eventHandlers.forEach((function(e){e()}))}},{key:"callEventCallbacks",value:function(e){this.eventCallbacks.length&&this.eventCallbacks.forEach((function(t){return t(e)}))}},{key:"sendEvent",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.contextNode,n=e.action,r=e.label,o=void 0===r?"":r,i=e.value,a=e.customParams,s=void 0===a?{}:a;if(!t||!n)return{};var c=t.closest("[data-analytics-category]").getAttribute("data-analytics-category"),u=Y(t.closest("[data-box-name]")),l=t.closest("[data-box-id]"),d=t.closest("[".concat(S,"]")),h=l&&G(l),f=Ze(t),p=function(e){var t=e.closest("[data-analytics-groups]");if(t){var n=decodeURIComponent(q(t,"data-analytics-groups"));try{n=T(n)}catch(e){return console.log("JSON.parse error! Can not convert ".concat(n," to JSON.")),[]}return n}return[]}(t),v=f.length?{analyticsTags:f}:{},g=p.length?{groups:p}:{},m=h?{boxName:u,boxId:h}:{boxName:u},b=Object.assign(Object.assign(Object.assign({},v),g),m),y={category:c,action:n,label:o,value:i,customParams:Me(Object.assign({},s),{_opbox:b},this.defaultCustomParams.ev,this.getFragmentAnalyticsContext(d))};return this.cookieMonsterClient.send("event",y),this.callEventCallbacks(y),y}},{key:"sendClickEvent",value:function(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"click"}))}},{key:"sendContextmenuEvent",value:function(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"contextmenu"}))}},{key:"sendBoxInteractionEvent",value:function(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"boxInteraction"}))}},{key:"sendItemViewEvent",value:function(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"itemView"}))}},{key:"sendBoxViewEvent",value:function(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"boxView"}))}},{key:"sendFormSubmitEvent",value:function(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"submit"}))}},{key:"handleBoxInteraction",value:function(e){if(F(e.target.closest)){var t=e.target.closest("[data-analytics-interaction]");if(t){var n=$e({contextNode:t}),r=q(t,"data-analytics-interaction-label")||"",o=q(t,"data-analytics-interaction-value")||pe(t).trim();this.sendBoxInteractionEvent({contextNode:t,label:r,value:o,customParams:n})}}}},{key:"shouldHandleBoxInteraction",value:function(e){return"mousedown"===e.type&&!this.isMobile&&(this.isSafari||this.isFirefox)&&"select-one"===e.target.type}},{key:"markParentBoxAsVisible",value:function(e){var t=e.parentNode&&e.parentNode.closest("[data-analytics-enabled]");this.boxViewsMarker&&t&&!Ue(t)&&this.boxViewsMarker.markBoxAsVisible(t,!0)}},{key:"sendPageViewProxy",value:function(){this.account&&(this.cookieMonsterClient.sendPageView(Je(this.defaultCustomParams.pv,this.viewId,et(this.targetWindow,this.isDarkModeEnabled))),this.cookieMonsterClient.updateReferrer())}},{key:"sendEventProxy",value:function(e,t,n,r,o){return this.account?e.nodeType===Node.ELEMENT_NODE?this.sendEvent({value:n,label:o,action:t,contextNode:e,customParams:r}):this.sendEvent(e):null}},{key:"sendItemViewEventProxy",value:function(e){var t=e.contextNode,n=e.label,r=e.value,o=e.customParams;this.account&&this.sendItemViewEvent({contextNode:t,label:n,value:r,customParams:Ke({contextNode:t,customParams:o,reportError:this.reportError})})}},{key:"sendClickEventProxy",value:function(e){var t=e.contextNode,n=e.label,r=e.value,o=e.customParams,i=e.destinationUrl,a=e.isNewTab;if(this.account){if(a&&"boolean"!==L(a))throw new Error("isNewTab property must be boolean");this.sendClickEvent({contextNode:t,label:n,value:r,customParams:Xe({contextNode:t,destinationUrl:i,customParams:o,isNewTab:a})})}}},{key:"sendContextmenuEventProxy",value:function(e){var t=e.contextNode,n=e.label,r=e.value,o=e.customParams,i=e.destinationUrl;this.account&&this.sendContextmenuEvent({contextNode:t,label:n,value:r,customParams:Xe({contextNode:t,destinationUrl:i,customParams:o})})}},{key:"sendBoxInteractionEventProxy",value:function(e){var t=e.contextNode,n=e.label,r=e.value,o=e.customParams;this.account&&this.sendBoxInteractionEvent({contextNode:t,label:n,value:r,customParams:$e({contextNode:t,customParams:o})})}},{key:"updateCustomParams",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.pv,n=void 0===t?{}:t,r=e.ev,o=void 0===r?{}:r,i=arguments.length>1?arguments[1]:void 0;this.viewId=i,D(n)&&D(o)?this.defaultCustomParams={pv:n,ev:o}:console.log("Can not update custom params with non-object arguments!")}},{key:"registerEventCallback",value:function(e){this.account&&e&&!this.eventCallbacks.includes(e)&&this.eventCallbacks.push(e)}},{key:"getFragmentAnalyticsContext",value:function(e){return this.fragmentCustomParams.get(e)||{}}},{key:"createAPI",value:function(){return{sendPageView:this.sendPageViewProxy.bind(this),sendEvent:this.sendEventProxy.bind(this),sendItemViewEvent:this.sendItemViewEventProxy.bind(this),sendClickEvent:this.sendClickEventProxy.bind(this),sendContextmenuEvent:this.sendContextmenuEventProxy.bind(this),sendBoxInteractionEvent:this.sendBoxInteractionEventProxy.bind(this),registerEventCallback:this.registerEventCallback.bind(this)}}}]),e}(),rt="";function ot(e){return D(e)&&!("clientImplementationVersion"in e)?I(e,{clientImplementationVersion:rt}):e}function it(e){var t=e.instance,n=e.method,r=e.reportError,o=e.data,i=void 0===o?null:o,a=e.onSuccess,s=void 0===a?function(){}:a;if(t&&F(t[n]))try{t[n](i),s()}catch(e){r(new Error('There was some problem executing "'.concat(n,'" method on box instance: ').concat(e.message)))}}function at(e,t){return t===rt?e:"".concat(e,"@").concat(t)}var st=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.targetWindow,i=n.services,a=n.reportError,s=n.unmountNodeCallback,c=n.mountNodeCallback,u=n.componentNodesFinder,l=n.serializedPropsFinder,d=n.registerPrototypeCallback;o(this,e),this.unmountNode=function(e){t.unmountNodeCallback(e),z(e,"div[data-prototype-id]").concat([e]).forEach((function(e){var n=G(e)||Y(e);it({instance:t.instances.get(n),method:"onUnmount",reportError:t.reportError}),t.instances.set(n,null)}))},this.mountNode=function(e){z(e,"div[data-prototype-id]").concat([e]).forEach((function(e){var n=Q(e),r=J(e)||rt;t.registerInstancesForPrototype(n,r,[e])})),t.mountNodeCallback(e)},this.updateComponentCallback=function(e,n){var r=t.instances.get(e);r?he((function(){it({instance:r,method:"onUpdate",reportError:t.reportError,data:n})})):t.boxDataCache.set(e,n)},this.beforeUpdateComponentCallback=function(){t.instances.forEach((function(e){return it({instance:e,method:"beforeOnUpdate",reportError:t.reportError})}))},this.register=function(e,n){var r=function(e){return V(e)?e.map(ot):ot(e)}(e);t.isPrototypeValid(r)&&t.isImplementationValid(n)&&(V(r)?r.forEach((function(e){t.registerImplementationAndInstances(e,n)})):t.registerImplementationAndInstances(r,n))},this.targetWindow=r,this.services=i,this.implementations=new Map,this.instances=new Map,this.boxDataCache=new Map,this.reportError=a,this.unmountNodeCallback=s,this.mountNodeCallback=c,this.registerPrototypeCallback=d,this.serializedPropsFinder=l,this.componentNodesFinder=u}return a(e,[{key:"isPrototypeObjectValid",value:function(e){var t=e.prototypeName,n=e.clientImplementationVersion;return"prototypeName"in e?""===t?(this.reportError(new Error('Property "prototypeName" cannot be empty string')),!1):B(t)?!!B(n)||(this.reportError(new Error('Property "clientImplementationVersion" must be string but got '.concat(L(n)))),!1):(this.reportError(new Error('Property "prototypeName" must be string but got '.concat(L(t)))),!1):(this.reportError(new Error('Property "handledPrototype" must have "prototypeName" field')),!1)}},{key:"containsValidPrototypes",value:function(e){var t=this;return 0===e.length?(this.reportError(new Error("Empty handledPrototypes list")),!1):!e.filter((function(e){return!t.isPrototypeObjectValid(e)})).length}},{key:"isPrototypeValid",value:function(e){return V(e)?this.containsValidPrototypes(e):D(e)?this.isPrototypeObjectValid(e):(this.reportError(new Error('"handledPrototype" argument must be an object or an array')),!1)}},{key:"isImplementationValid",value:function(e){return F(e)?e.prototype.onUpdate&&!F(e.prototype.onUpdate)?(this.reportError(new Error('"onUpdate" property must be a function or undefined but got '.concat(L(e.prototype.onUpdate)))),!1):!!F(e.prototype.onMount)||(this.reportError(new Error('"implementation" class has to have "onMount" method')),!1):(this.reportError(new Error('"implementation" must be a class')),!1)}},{key:"registerInstancesForPrototype",value:function(e,t,n){var r=this.implementations.get(at(e,t));r&&(this.registerInstances(n,this.services.getServicesForComponent(e),r),this.registerPrototypeCallback(e,t))}},{key:"registerImplementationAndInstances",value:function(e,t){var n=e.prototypeName,r=e.clientImplementationVersion,o=at(n,r),i=r===rt;this.implementations.has(o)?this.reportError(new Error("".concat(n," ").concat(i?"":"with ".concat(r," client implementation version "),"already registered!"))):(this.implementations.set(o,t),this.registerInstancesForPrototype(n,r,this.componentNodesFinder.find(n,r)))}},{key:"registerInstances",value:function(e,t,n){var r=this;e.forEach((function(e){if(!q(e,S)){var o=Y(e),i=G(e),a=r.serializedPropsFinder.getPropsForBox(i,o),s=new n({baseNode:e,props:a,services:t}),c=i||o;he((function(){r.instances.get(c)||(it({instance:s,method:"onMount",reportError:r.reportError,onSuccess:function(){r.instances.set(c,s)}}),r.boxDataCache.has(c)&&(it({instance:s,method:"beforeOnUpdate",reportError:r.reportError}),r.updateComponentCallback(c,r.boxDataCache.get(c)),r.boxDataCache.delete(c)))}))}}))}},{key:"createPublicAPI",value:function(){return{register:this.register}}},{key:"createPrivateAPI",value:function(){var e=this;return{updateComponentCallback:this.updateComponentCallback,beforeUpdateComponentCallback:this.beforeUpdateComponentCallback,unmountNode:this.unmountNode,mountNode:this.mountNode,updateSerializedPropsCollection:function(){e.serializedPropsFinder.updateNodesCollection()},updateComponentNodesCollection:function(){e.componentNodesFinder.updateNodesCollection()}}}}]),e}(),ct="data-serialize-box-id",ut="data-serialize-box-name",lt="script[".concat(ct,"], script[").concat(ut,"]"),dt=function(){function e(t,n){o(this,e),this.targetWindow=t,this.reportError=n,this.collection=[],this.updateNodesCollection()}return a(e,[{key:"updateNodesCollection",value:function(){this.collection=z(this.targetWindow.document,lt)}},{key:"getNodeByBoxId",value:function(e){return this.collection.find((function(t){return q(t,ct)===e}))}},{key:"getNodeByBoxName",value:function(e){return this.collection.find((function(t){return q(t,ut)===e}))}},{key:"getPropsFromNode",value:function(e){if(!e)return{};try{return T(pe(e))}catch(e){return this.reportError(e),{}}}},{key:"getPropsForBox",value:function(e,t){var n=this.getNodeByBoxId(e)||this.getNodeByBoxName(t);return n?this.getPropsFromNode(n):{}}}]),e}(),ht=function(e,t){return function(e,n){var r=e.prototypeName;r&&n({domNodes:t.find(r)})}},ft=["Content-Type"],pt=function(){return Promise.reject(new Error("missing edge host"))},vt="application/vnd.allegro.public.v1+json",gt=function(){function e(t){var n=this,r=t.httpClient,i=t.edgeHost,a=t.language;o(this,e),this.get=function(e,t){return n.httpClient.get(n.prepareRequestUrl(e),n.prepareRequestSettings(t,!0))},this.put=function(e,t,r){return n.httpClient.put(n.prepareRequestUrl(e),t,n.prepareRequestSettings(r))},this.post=function(e,t,r){return n.httpClient.post(n.prepareRequestUrl(e),t,n.prepareRequestSettings(r))},this.patch=function(e,t,r){return n.httpClient.patch(n.prepareRequestUrl(e),t,n.prepareRequestSettings(r))},this.delete=function(e,t){return n.httpClient.delete(n.prepareRequestUrl(e),n.prepareRequestSettings(t,!0))},this.edgeHost=i,this.httpClient=r,this.defaultHeaders={"Content-Type":vt,Accept:vt,"Accept-Language":a}}return a(e,[{key:"prepareRequestSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.disableDefaultHeaders)return e;var n=this.normalizeSettings(e),r=this.defaultHeaders;r["Content-Type"];var o=f(r,ft);return Me({},t?{headers:o}:{headers:this.defaultHeaders},n)}},{key:"normalizeSettings",value:function(e){if(!e||!e.headers)return e;var t=re(e.headers,A(this.defaultHeaders));return I(e,{headers:t})}},{key:"prepareRequestUrl",value:function(e){return this.edgeHost+e}},{key:"createAPI",value:function(){return this.edgeHost?{get:this.get,put:this.put,post:this.post,patch:this.patch,delete:this.delete}:{get:pt,put:pt,post:pt,patch:pt,delete:pt}}}]),e}();function mt(e){var t,n=this,r=e.targetWindow,o=e.alias,i=void 0===o?"cm":o,a=e.config,s=void 0===a?{}:a,c=s.cookieMonster,u=c.host,l=c.account,d=c.encodedUserId,h=c.defaultCustomParams,f=void 0===h?{}:h,p=s.viewId,v=s.isDarkModeEnabled,g=r.document,m=function(){return F(r[i])},b=function(){if(!m()){r["cm.analytics.object"]=i,r[i]=r[i]||function(){(r[i].q=r[i].q||[]).push(R(arguments))};var e=g.createElement("script");e.src=u,g.head.appendChild(e)}};function y(){m()&&r[i].apply(null,R(arguments))}function w(){var e="send@".concat(l);y.apply(null,[e].concat(R(arguments)))}var C=function(){w("pageview",{customParams:arguments.length>0&&void 0!==arguments[0]?arguments[0]:Je(f.pv,p,et(r,v)),referrer:t})},E=function(){t=window.location.href},k={initialize:function(){u&&l&&!m()?(b(),y("create",l,{userId:d}),C(),E()):E()},updateReferrer:E,send:w,sendPageView:C};A(k).forEach((function(e){n[e]=k[e]}))}var bt=function(){function e(t){var n,r,i,a,s=this,c=t.targetWindow,u=t.boxes,l=void 0===u?[]:u,d=t.significantElementSizePercentage,h=void 0===d?.75:d,f=t.significantElementSizeForBiggerThanViewportPercentage,p=void 0===f?.5:f,v=t.timeoutValue,g=void 0===v?500:v,m=t.debounceTimeoutValue,b=void 0===m?20:m;o(this,e),this.markCurrentlyVisibleElementsAsSeen=function(){var e=s.config.timeoutValue;s.visibleElements.forEach((function(t){ze(t,e,e)}))},this.markPreviouslyVisibleElementAsHidden=function(e){s.visibleElementsByIntersectionObserver.has(e)&&(s.visibleElementsByIntersectionObserver.delete(e),te(e,"outOfViewport"))},this.intersectionHandler=function(e){e.forEach((function(e){var t=e.target,n=e.boundingClientRect,r=e.rootBounds;r&&function(e,t,n,r){var o=e.right-e.left,i=e.bottom-e.top,a=t.height,s=t.width,c=function(e,t){return(e.top>=t.top&&e.top<=t.bottom||e.bottom<=t.bottom&&e.bottom>=t.top||e.top<t.top&&e.bottom>t.bottom)&&(e.left>=t.left&&e.left<=t.right||e.right<=t.right&&e.right>=t.left||e.left<t.left&&e.right>t.right)}(e,t),u=c?He(e.left,e.right,t.width,o):0,l=c?He(e.top,e.bottom,t.height,i):0;return i>a&&l>a*r||o>s&&u>s*r||l*u/(o*i)>n}(n,r,s.config.significantElementSizePercentage,s.config.significantElementSizeForBiggerThanViewportPercentage)?s.visibleElementsByIntersectionObserver.has(t)||(s.visibleElementsByIntersectionObserver.add(t),s.notVisibleElements.delete(t),te(t,"inViewport")):(s.markPreviouslyVisibleElementAsHidden(t),s.notVisibleElements.add(t))})),s.resetCurrentlyVisibleElementsOnTimeout()},this.scrollHandler=function(){s.state.isScrolling||(s.state.scrollStartTime=(new Date).getTime(),s.state.isScrolling=!0),clearTimeout(s.markCurrentlyVisibleElementsAsSeenOnTimeout()),s.scrollEndHandler()},this.addBox=function(e){null!==e&&-1===s.boxes.indexOf(e)&&(s.boxes.push(e),s.observer.observe(e))},this.isBoxInViewport=function(e){return s.visibleElementsByIntersectionObserver.has(e)},this.markBoxAsRendered=function(e){return _(e,Be)&&s.addBox(e),Fe(e).forEach(s.addBox),Promise.resolve()},this.markBoxAsVisible=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(s.addBox(e),t){var n=s.config.timeoutValue;ze(e,n,n)}},this.recursivelyMarkBoxAsVisible=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];s.markBoxAsVisible(e,t),Fe(e).forEach((function(e){return s.markBoxAsVisible(e,t)}))},this.removeBox=function(e,t){null!==e&&(s.markPreviouslyVisibleElementAsHidden(e),function(e){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&Le.delete(e),De.delete(e)}(e,t),s.boxes=s.boxes.filter((function(t){return t!==e})),s.visibleElements=s.visibleElements.filter((function(t){return t!==e})),s.observer.unobserve(e))},this.markBoxAsHidden=function(e){s.removeBox(e,!1),s.resetCurrentlyVisibleElementsOnTimeout()},this.unmountNode=function(e){We(e).forEach(s.removeBox)},this.recursivelyMarkBoxAsHidden=function(e){s.markBoxAsHidden(e),Fe(e).forEach(s.markBoxAsHidden)},this.trackBoxScroll=function(e){ce(e,"scroll",s.scrollHandler)},this.targetWindow=c,this.document=c.document,this.config={timeoutValue:g,debounceTimeoutValue:b,significantElementSizePercentage:h,significantElementSizeForBiggerThanViewportPercentage:p},this.resetState(),this.boxes=l.length?l:Fe(c.document),this.visibleElements=[],this.visibleElementsByIntersectionObserver=new Set,this.notVisibleElements=new Set,this.observer=new c.IntersectionObserver(this.intersectionHandler,{threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}),this.scrollEndHandler=ee(this.resetCurrentlyVisibleElementsAfterScroll,b),this.resetCurrentlyVisibleElementsOnTimeout=(n=this.resetCurrentlyVisibleElements.bind(this),r=b,function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];var s=this;return new Promise((function(e){var o=i&&!a;clearTimeout(a),a=setTimeout((function(){a=null,i||e(n.apply(s,t))}),r),o&&e(n.apply(s,t))}))}),this.markCurrentlyVisibleElementsAsSeenOnTimeout=ee(this.markCurrentlyVisibleElementsAsSeen,g)}return a(e,[{key:"resetState",value:function(){var e=le();this.state={isScrolling:!1,scrollStartTime:e,counterStartTime:e}}},{key:"markPreviouslyVisibleElementsAsSeen",value:function(){var e=this,t=le();this.visibleElements.forEach((function(n){ze(n,t-e.state.counterStartTime,e.config.timeoutValue)}))}},{key:"markPreviouslyVisibleElementsAsSeenAfterScroll",value:function(){var e=this;this.visibleElements.forEach((function(t){ze(t,e.state.scrollStartTime-e.state.counterStartTime,e.config.timeoutValue)}))}},{key:"resetCurrentlyVisibleElements",value:function(){var e=this;this.markPreviouslyVisibleElementsAsSeen(),this.visibleElements=[],this.visibleElementsByIntersectionObserver.forEach((function(t){return e.visibleElements.push(t)})),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}},{key:"resetCurrentlyVisibleElementsAfterScroll",value:function(){var e=this;this.markPreviouslyVisibleElementsAsSeenAfterScroll(),this.notVisibleElements.forEach((function(t){e.observer.unobserve(t),e.observer.observe(t)})),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}},{key:"initialize",value:function(){var e=this;ce(this.targetWindow,"scroll",this.scrollHandler),this.boxes.forEach((function(t){return e.observer.observe(t)}))}},{key:"createAPI",value:function(){return{markBoxAsRendered:this.markBoxAsRendered,markBoxAsVisible:this.markBoxAsVisible,recursivelyMarkBoxAsVisible:this.recursivelyMarkBoxAsVisible,markBoxAsHidden:this.markBoxAsHidden,recursivelyMarkBoxAsHidden:this.recursivelyMarkBoxAsHidden,trackBoxScroll:this.trackBoxScroll,isBoxInViewport:this.isBoxInViewport}}}]),e}();function yt(e,t){var n=function(e){return e.replace("?","").split("&").filter(Boolean).map((function(e){return e.split("=")})).reduce((function(e,t){var n=v(t,2),r=n[0],o=n[1];return e[r]?e[r].push(o):e[r]=[o],e}),{})}(e);return Object.entries(n).filter((function(e){var n=v(e,1)[0].replace(/\+/g,"%20");return!Object.keys(t).map((function(e){return encodeURIComponent(e)})).includes(n)})).map((function(e){var t=v(e,2),n=t[0];return t[1].map((function(e){return"".concat(n,"=").concat(null!=e?e:"")})).join("&")}))}function wt(e){var t=v(e,2),n=t[0],r=t[1];return null==r||0===r.length?"":Array.isArray(r)?r.map((function(e){return"".concat(encodeURIComponent(n),"=").concat(encodeURIComponent(e))})).join("&"):"".concat(encodeURIComponent(n),"=").concat(encodeURIComponent(r))}function Ct(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=Object.fromEntries(t.map((function(e){return[e.name,e.value]}))),r=yt(e,n),o=function(e){return Object.entries(e).map(wt).filter(Boolean)}(n),i=[].concat(g(r),g(o)).join("&");return i?"?".concat(i):""}var Et=function(){function e(t){var n=this,r=t.targetWindow,i=t.opboxWebClient,a=t.rawDataListenersRegistry,s=t.reportError;o(this,e),this.navigateRelative=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.persistHash,o=void 0!==r&&r,i=t.shouldReplaceState,a=void 0!==i&&i,s=new URL(n.location),c=n.location.search;o||(s.hash="");var u=Ct(c,null==e?void 0:e.filter((function(e){return!e.fetchUrlOnly}))),l=Ct(c,e),d=s.pathname+u+s.hash;return l!==n.lastFetchParams&&n.fetch(l),u!==c&&(n.changeUrl(d,a),n.changeCallbacks.forEach((function(e){return e()})),n.targetWindow.performance.mark("clientSideNavigationStart")),d},this.refreshPage=function(){n.fetch(n.location.search)},this.changeState=function(e){var t=e.queryParameters,r=e.hash,o=e.shouldChangeHistory;if(!t&&!B(r))return n.reportError(new Error("New parameters (array) or hash (string) required")),null;var i=new URL(n.location),a=null==t?void 0:t.filter((function(e){return!e.fetchUrlOnly})),s=n.location.search;i.search=Ct(s,a),B(r)&&(i.hash=r);var c=n.location.pathname+i.search+i.hash;return i.href!==n.location.href&&(n.changeUrl(c,!o),n.changeStateCallbacks.forEach((function(e){return e()}))),c},this.registerChangeCallback=function(e){n.registerCallback(e,n.changeCallbacks)},this.registerChangeStateCallback=function(e){n.registerCallback(e,n.changeStateCallbacks)},this.removeChangeCallback=function(e){n.changeCallbacks=n.removeCallback(e,n.changeCallbacks)},this.removeChangeStateCallback=function(e){n.changeStateCallbacks=n.removeCallback(e,n.changeStateCallbacks)},this.targetWindow=r,this.location=r.location,this.opboxWebClient=i,this.rawDataListenersRegistry=a,this.reportError=s,this.lastFetchParams=this.location.search,this.changeCallbacks=[],this.changeStateCallbacks=[]}return a(e,[{key:"initialize",value:function(){var e=this;this.targetWindow.addEventListener("popstate",(function(t){return e.handlePopState(t)}))}},{key:"changeUrl",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?this.targetWindow.history.replaceState("","",e):this.targetWindow.history.pushState("","",e)}},{key:"handlePopState",value:function(e){var t=e.target.location.search;this.lastFetchParams!==t&&this.refreshPage()}},{key:"fetch",value:function(e){var t=this,n=this.location.pathname+e;this.lastFetchParams=e,this.rawDataListenersRegistry.triggerProgressListener(),this.opboxWebClient.getPageData(n).then((function(e){return t.rawDataListenersRegistry.triggerChangeListener(e)})).catch((function(e){e.message!==ve&&t.reportError(new Error("Error while fetching page data for path ".concat(n,": ").concat(e.message)))}))}},{key:"registerCallback",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];F(e)?t.push(e):this.reportError(new Error('First argument must be a function but got "'.concat(L(e),'"')))}},{key:"removeCallback",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(F(e)){var n=t.filter((function(t){return t!==e}));return n.length===t.length&&this.reportError(new Error("Trying to remove unregistered callback")),n}return this.reportError(new Error('First argument must be a function but got "'.concat(L(e),'"'))),t}},{key:"createAPI",value:function(){return{registerChangeCallback:this.registerChangeCallback,registerChangeStateCallback:this.registerChangeStateCallback,removeChangeCallback:this.removeChangeCallback,removeChangeStateCallback:this.removeChangeStateCallback,changeState:this.changeState}}}]),e}(),kt=500,xt="opboxAnimationTimerInterval",Pt={easeInOutQuart:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}};function St(e,t,n,r){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=o.duration,a=void 0===i?kt:i,s=o.onFinish;if(!F(r))return null;var c=le(),u=n-t,l=t,d=!1;return function o(){var i=le()-c;if(d||i>=a)l===n||r(n),F(s)&&s(),d=!1;else{var h=Math.min(i/a,1);l=Pt.easeInOutQuart(h)*u+t,r(l),e.requestAnimationFrame(o)}}(),{stop:function(){d=!0}}}function It(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).duration,r=void 0===n?kt:n,o=e.pageYOffset,i=Math.max(0,t),a=e.document.body.scrollHeight;function s(){e[xt]&&F(e[xt].stop)&&(e[xt].stop(),e[xt]=null)}s(),e[xt]=St(e,o,t,(function(t){var n,r,o;e.scrollTo(0,Math.round(t)),r=(n=t)===i||n===i,o=e.innerHeight+n>=a,(r||o)&&s()}),{duration:r})}var Ot=function(){function e(){var t=this;o(this,e),this.status=1,this.promise=new Promise((function(e){t.resolve=e}))}return a(e,[{key:"registerImplementation",value:function(e){this.status=2,this.resolve(e)}}]),e}(),At=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.reportError,i=n.allowedPlugins,a=void 0===i?[]:i;o(this,e),this.addPluginToRegistry=function(e){var n=e.name;t.isPluginAvailable(n)||t.pluginsRegistry.set(n,new Ot)},this.register=function(e,n){if(e){var r=e.name;if(B(r))if(r)if(n)if(t.isPluginAvailable(r)){var o=t.pluginsRegistry.get(r);2!==o.status?o.registerImplementation(n):t.reportRegistrationError('Plugin "'.concat(r,'" is already registered on page'),!0)}else t.reportRegistrationError('Plugin "'.concat(r,'" is not allowed to register on this page'));else t.reportRegistrationError('Second argument "implementation" is required');else t.reportRegistrationError('Property "name" should be a non-empty string');else t.reportRegistrationError('Property "name" should be a string')}else t.reportRegistrationError('First argument "config" should be defined')},this.getPlugin=function(e){return t.isPluginAvailable(e)?t.pluginsRegistry.get(e).promise:Promise.reject(new Error('Plugin "'.concat(e,'" is unavailable')))},this.updateRegistry=function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach(t.addPluginToRegistry)},this.reportError=r,this.pluginsRegistry=new Map,this.boundUpdateRegistry=this.updateRegistry,this.updateRegistry(a)}return a(e,[{key:"isPluginAvailable",value:function(e){return this.pluginsRegistry.has(e)}},{key:"reportRegistrationError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new Error("Plugin registration error. ".concat(e));t?console.error(n):this.reportError(n)}},{key:"createAPI",value:function(){return{register:this.register,get:this.getPlugin}}}]),e}();function Nt(e,t){return function(n){if(!e.has(n))return Promise.reject(new Error("Service ".concat(n," is not registered")));var r=e.get(n);return r.fetchIfNotFetched(t),r.promise}}var jt=a((function e(t){var n=this,r=t.prototypeName,i=t.servicesRegistry,a=t.targetWindow;o(this,e),this.services=new Map,i.forEach((function(e,t){e.components.some((function(e){return e===r}))&&n.services.set(t,e)})),this.get=Nt(this.services,a)})),Rt=["tags"],Tt=function(e,t){var n,r,o,i,a=e.document.documentElement,s=a.clientWidth,c=a.clientHeight,u=e.navigator.userAgent,l=(n=e.navigator,r=n.connection,o=n.mozConnection,i=n.webkitConnection,r||o||i||{}).downlink,d="".concat(s,"x").concat(c),h=!U(t);return Object.assign(Object.assign({device:{viewport:d,ua:u}},h&&{other:t}),l&&{connection:{speed:l}})},Mt=function(e){return function(t,n){if(0!==t.status){var r=n||{},o=r.tags,i=f(r,Rt);console.error("Error: ".concat(t.message)),e.opbox.plugin.get("sentry").then((function(n){return n.captureException(t,Object.assign({contexts:Tt(e,i)},!U(o)&&{tags:o}))})).catch(Z)}}};function Vt(e,t){return t.filter((function(t){return!e.find((n=t,function(e){if(n.url)return[e.url,e.href,e.src].includes(n.url);if(n.code){var t=n.attributes,r=void 0===t?{}:t,o=!A(r).some((function(t){return r[t]!==q(e.node,t)}));return n.code===e.code&&o}return!1}));var n}))}function Lt(e,n,o){if(!n.length)return Promise.resolve();var i=function(e){return j(e.document.getElementsByTagName("script"),(function(e){return{src:e.src,code:e.innerHTML,nonce:e.nonce,node:e}}))}(e),a=function(e){return(e.find((function(e){return!!e.nonce}))||{}).nonce}(i),s=v(Vt(i,n).reduce((function(e,t){return e[t.async?0:1].push(t),e}),[[],[]]),2),c=s[0],u=s[1],l=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z,r=e.document,o=Mt(e),i=de(e);return function(e){var a=e.url,s=e.code,c=e.attributes,u=e.type;return a||s?new Promise((function(e){var l,d=!a&&!!s,h="module"===u,f=K(r,"script"),p=!1,g=function t(n){e(),n.message||(n.message="Error while loading script: ".concat(a)),o(n),ue(f,"error",t)};if(!h||i){if(c){if(c.nomodule&&i)return void e();N(c).forEach((function(e){var t=v(e,2),n=t[0],o=t[1];"data-serialize-box-id"!==n&&"data-serialize-box-name"!==n||(p=!0,l=H(r,"[".concat(n,'="').concat(o,'"]'))),f.setAttribute(n,o)}))}t&&f.setAttribute("nonce",t),u&&(f.type=u),d?(f.innerHTML=s,e()):(f.src=a,ce(f,"load",(function t(){e(),ue(f,"error",g),ue(f,"load",t)})),ce(f,"error",g)),l?l.parentNode.replaceChild(f,l):r.head.appendChild(f),p&&n()}else e()})):Promise.resolve()}}(e,a,o),d=function(){var e,n=(e=t().mark((function e(){var n,r,o,i,a=arguments;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=a.length>0&&void 0!==a[0]?a[0]:[]).length){e.next=3;break}return e.abrupt("return",Promise.resolve());case 3:return r=m(t=n)||b(t)||y(t)||C(),o=r[0],i=r.slice(1),e.next=6,l(o);case 6:return e.abrupt("return",d(i));case 7:case"end":return e.stop()}var t}),e)})),function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function s(e){r(a,o,i,s,c,"next",e)}function c(e){r(a,o,i,s,c,"throw",e)}s(void 0)}))});return function(){return n.apply(this,arguments)}}();return d(u).then((function(){return Promise.all(c.map(l))}))}var Dt=function(){function e(t){var n=this,r=t.assetUrls,i=t.components,a=t.reportError;o(this,e),this.assetUrls=r,this.components=i,this.reportError=a,this.implementation=null,this.status=0,this.promise=new Promise((function(e,t){n.resolve=e,n.reject=t}))}return a(e,[{key:"update",value:function(e){this.components=function(e,t){return t.reduce((function(e,t){return e.find((function(e){return e===t}))?e:e.concat([t])}),e)}(this.components,e)}},{key:"registerImplementation",value:function(e){try{this.implementation=new e,this.status=2,this.resolve(this.implementation)}catch(e){this.handleError(new Error("Error while trying to register service implementation: ".concat(e.message)))}}},{key:"fetchIfNotFetched",value:function(e){var t=this;if(0===this.status){this.status=1;var n=this.assetUrls,r=n.module,o=n.nomodule;Lt(e,[de(e)?{url:r,type:"module"}:{url:o}]).catch((function(e){t.handleError(new Error("Error while trying to inject service scripts: ".concat(e?e.message:"")))}))}}},{key:"handleError",value:function(e){this.reportError(e),this.status=2,this.reject()}}]),e}(),Bt=function(){function e(t){var n=this,r=t.targetWindow,i=t.reportError;o(this,e),this.update=function(e){e.forEach((function(e){var t=v(e,2),r=t[0],o=t[1],i=o.nomodule,a=o.module,s=o.components;n.servicesRegistry.has(r)?n.servicesRegistry.get(r).update(s):n.setServiceToRegistry(r,{nomodule:i,module:a},s)}))},this.register=function(e,t){var r=e.serviceName;n.servicesRegistry.get(r).registerImplementation(t)},this.targetWindow=r,this.reportError=i,this.servicesRegistry=new Map;var a=H(r.document,'script[data-config="services"]');if(a)try{T(pe(a)).forEach((function(e){var t=v(e,2),r=t[0],o=t[1],i=o.nomodule,a=o.module,s=o.components;n.setServiceToRegistry(r,{nomodule:i,module:a},s)}))}catch(e){i(e)}this.dangerouslyGet=Nt(this.servicesRegistry,r)}return a(e,[{key:"getServicesForComponent",value:function(e){return new jt({prototypeName:e,servicesRegistry:this.servicesRegistry,targetWindow:this.targetWindow})}},{key:"setServiceToRegistry",value:function(e,t,n){this.servicesRegistry.set(e,new Dt({assetUrls:t,components:n,reportError:this.reportError}))}},{key:"createAPI",value:function(){return{register:this.register,__dangerouslyGet__:this.dangerouslyGet.bind(this)}}}]),e}();function Wt(e,t){e.forEach((function(e){var n=e.args,r=e.reject,o=e.resolve,i=function(e,t){try{return e.apply(void 0,g(t))}catch(e){return void console.error(e)}}(t,n);i&&F(i.then)&&F(o)&&F(r)&&i.then(o,r)}))}function Ft(e,t,n){for(var r=arguments.length,o=new Array(r>3?r-3:0),i=3;i<r;i++)o[i-3]=arguments[i];if(F(e)&&F(t)){if(!e.__queue__)return;Wt(e.__queue__,t),n.apply(void 0,[t].concat(o))}else D(e)&&D(t)&&A(e).forEach((function(r){Ft.apply(void 0,[e[r],t[r],n].concat(g(o.concat(r))))}))}var Ut=a((function e(t){var n=this,r=t.localStorage,i=t.reportError,a=t.ttlMs,c=void 0===a?2592e6:a,u=t.key,l=void 0===u?"opbox.preferences":u,d=t.timeProvider,h=void 0===d?le:d;o(this,e),this.savePreferences=function(e){var t=n.loadPreferences(),r=n.timeProvider(),o=e.reduce(se((function(e){return s({},e.name,{value:e.value,timestamp:r})})),t);n.writeToStorage(o)},this.writeToStorage=function(e){try{n.storage.setItem(n.key,M(e))}catch(e){n.reportError(new Error("Error while writing data to storage. Error message: ".concat(e.message)))}},this.loadPreferences=function(){try{return T(n.storage.getItem(n.key))||{}}catch(e){return n.reportError(new Error("Error while loading data from storage. Error message: ".concat(e.message))),{}}},this.cleanupPreferences=function(){var e=n.loadPreferences(),t=n.timeProvider(),r=N(e).reduce(se((function(e){var r=v(e,2),o=r[0],i=r[1];return i.timestamp+n.ttlMs>t?s({},o,i):{}})),{});n.writeToStorage(r)},this.storage=r,this.ttlMs=c,this.key=l,this.timeProvider=h,this.reportError=i})),zt=function(){function e(){o(this,e)}return a(e,[{key:"savePreferences",value:function(){}},{key:"loadPreferences",value:function(){return{}}},{key:"cleanupPreferences",value:function(){}}]),e}(),Ht=["Content-Type"],_t="/preferences",qt="illegal argument type provided as preferences",Qt={withCredentials:!0,headers:{"Content-Type":"application/vnd.allegro.internal.v1+json",Accept:"application/vnd.allegro.internal.v1+json"}},Gt=function(){function e(t){var n=this,r=t.edgeClient,i=t.localStorage,a=t.ttlMs,c=t.reportError;o(this,e),this.setPreference=function(e,t){var r={name:e,value:t};return n.storage.savePreferences([r]),n.edgeClient.post(_t,r,Qt)},this.getPreference=function(e,t){return B(e)||e instanceof String?n.getPreferences(s({},e,t)).then((function(t){return t[e]})):Promise.reject(Error("illegal argument type provided as preference name"))},this.setPreferences=function(e){if(!D(e))return Promise.reject(Error(qt));var t=N(e).map((function(e){var t=v(e,2);return{name:t[0],value:t[1]}}));return n.storage.savePreferences(t),n.edgeClient.post("/preferences/multi",M(t),Qt)},this.getPreferences=function(e){if(!D(e))return Promise.reject(Error(qt));var t=A(e).join(","),r="".concat(_t,"?name=").concat(t),o=Qt.withCredentials,i=Qt.headers;i["Content-Type"];var a=f(i,Ht);return n.edgeClient.get(r,{withCredentials:o,headers:a}).then((function(e){var t=e.data.preferences;return n.storage.savePreferences(t),t.reduce(se((function(e){return s({},e.name,e.value)})),{})})).catch((function(){return n.getPreferencesFromLocalStorageOrDefaults(e)}))},this.getPreferencesFromLocalStorageOrDefaults=function(e){n.storage.cleanupPreferences();var t=n.storage.loadPreferences();return N(e).reduce(se((function(e){var n=v(e,2),r=n[0],o=n[1];return s({},r,r in t?t[r].value:o)})),{})},this.edgeClient=r,this.storage=function(e){try{var t="test_preferences_storage";return e.setItem(t,t),e.getItem(t),e.removeItem(t),!0}catch(e){return!1}}(i)?new Ut({localStorage:i,ttlMs:a,reportError:c}):new zt}return a(e,[{key:"createAPI",value:function(){return{set:this.setPreference,get:this.getPreference,setMany:this.setPreferences,getMany:this.getPreferences}}}]),e}(),Yt="#svg-color-matrix-filters";var Jt=["assets","spinner","button","link","badge","brand","bubble","card","chart","desk","divider","heading","hint","icon","indicator","input","list","timeline","timer","marker","notification","placeholder","price","progress","table","dropdown","breadcrumb","accordion","carousel","chip","choice","dialog","field","image-tile","input-group","message","modal","pagination","range","select","sheet","slider","soap","stepper","switch","tabs","typography","color","grid","board","calendar","datepicker","attachment","article","navigation-tiles","pin","player-video","tip","align","border","box-sizing","display","flex","height","margin","outline","padding","position","transition","utils","visibility","white-space","width","zindex","core"];var Kt=["crossOrigin"];var Xt,$t=function(e,t,n){var r=t.href,o=t.media,i=t.crossOrigin,a=function(e,t){var n=e.document,r=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).referenceNode,o=void 0===r?null:r;return function(e){if(U(e))return null;oe(e,(function(e,t){return!(t||Kt.includes(e))}));var r=K(n,"link",e,{rel:t});return o?function(e,t){e.insertAdjacentElement("afterend",t)}(o,r):n.head.appendChild(r),r}}(e,"stylesheet",{referenceNode:n})(Object.assign({type:"text/css",href:r,media:o},!W(i)&&{crossOrigin:i}));return new Promise((function(e,t){ce(a,"error",t),ce(a,"load",e)}))},Zt=function(e){return function(t){return t.href.includes("".concat(e,"/"))}},en=function(e,t,n){var r=e.filter((function(e){return e.isMetrum})),o=t.slice(0,t.indexOf(n)).reverse().find((function(e){return r.find(Zt(e))})),i=o?r.find(Zt(o)).node:null;return!i&&r.length?r[0].node.previousElementSibling:!i&&e.length?e[0].node.previousElementSibling:i};function tn(e,t){return e.findIndex((function(e){return e.selectorText===t}))}function nn(e,t,n){var r=t.cssBundle,o=r.isEnabled,i=r.emptyRule,a=o?function(e){return j(e.document.styleSheets).find((function(e){var t=e.ownerNode;return t&&_(t,"data-metrum-bundle")}))}(e):null,s=[],c=function(e){return i.pattern.replace(i.replacementPart,e)};return{isEnabled:o,inject:function(t){if(!o)return Promise.resolve();var r,i,u,l,d,h,f=function(e,t){return t.reduce((function(t,n){var r=v(t,2),o=r[0],i=r[1];return e.includes(n)||i.push(n),o.push(n),[o,i]}),[[],[]])}(s,t),p=v(f,2),g=p[0],m=p[1];return s=g,m.length?(r=e.document,i=m,u=r.createDocumentFragment(),l=i.map((function(e){return K(r,"link",{type:"text/css",rel:"stylesheet",crossOrigin:"",href:e,media:"not all"})})),d=l.map((function(e){return new Promise((function(t,n){ce(e,"load",(function(){t(e.sheet)})),ce(e,"error",n),u.appendChild(e)}))})),h=function(){l.forEach((function(e){e.remove()}))},r.head.appendChild(u),Promise.all(d).then((function(e){return[e,h]}))).then((function(e){var t=v(e,2),r=t[0],o=t[1];r.forEach((function(e){var t=j(a.cssRules),r=t.length;if(!function(e,t){return t.cssRules.length>0&&e.findIndex((function(e){return e.cssText===t.cssRules[0].cssText}))>-1}(t,e)){for(var o=$(e.href),i=n.indexOf(o),s=-1!==i?n.slice(i):[],u=r,l=0;l<s.length;l+=1){var d=tn(t,c(s[l]));if(d>0){u=d;break}}var h=j(e.cssRules);h.unshift({cssText:"".concat(c(o),"{}")});for(var f=0;f<h.length;f+=1)a.insertRule(h[f].cssText,u+f)}})),o()})):Promise.resolve()}}}function rn(e,t,n){var r=e.document.createDocumentFragment(),o=n.map((function(n){var o=n.url,i=n.code,a=n.media;if(X(o))return function(e,t,n,r){var o=n.href,i=n.media,a=$(o);return r.includes(a)?$t(e,{href:o,media:i,crossOrigin:""},en(t,r,a)):Promise.resolve()}(e,t,{href:o,media:a},Jt);if(o){var s=K(e.document,"link",Object.assign({type:"text/css",rel:"stylesheet",crossOrigin:"",href:o},a?{media:a}:{}));return r.appendChild(s),new Promise((function(e,t){s.addEventListener("error",(function(){return t(new Error("Loading external styles failed"))})),s.addEventListener("load",e)}))}return i?(r.appendChild(K(e.document,"style",{textContent:i})),Promise.resolve()):Promise.reject(new Error("Given styles have empty code/href"))}));return e.document.head.appendChild(r),Promise.all(o)}function on(e,t,n){if(!t.length)return Promise.resolve();var r=[].concat(g(z(e.document,'link[type="text/css"],style',(function(e){return{href:e.href,code:e.innerHTML,media:e.media,node:e,isMetrum:X(e.href)}})).filter((function(e){var t=e.href,n=e.code;return t||n}))),g(function(e,t,n){var r=[],o=H(e,n.selectors.bundledStylesMap);if(!o)return r;try{return T(pe(o))}catch(e){return t(new Error("Bundled styles map: invalid JSON")),r}}(e.document,Mt(e),n))),o=Vt(r,t),i=Xt=Xt&&!Xt.forceRefresh?Xt:nn(e,n,Jt),a=i.inject,s=i.isEnabled,c=v(o.reduce((function(e,t){return X(t.url)&&s?(e[0].push(t.url),e):(e[1].push(t),e)}),[[],[]]),2),u=c[0],l=c[1];return Promise.all([rn(e,r,l),a(u)])}function an(e){var t=e.targetWindow,n=e.webResponse,r=e.config,o=n.svgColorMatrixFilters,i=void 0===o?"":o,a=n.assets,s=(void 0===a?{}:a).styles,c=void 0===s?[]:s;return function(e,t){var n=e.document;if(t){var r=H(n,Yt),o=H(K(n,"div",{innerHTML:t}),"svg");r?z(o,"filter",(function(e){H(r,"#".concat(q(e,"id")))||r.appendChild(e)})):n.body.insertBefore(o,n.body.firstChild)}}(t,i),on(t,c,r)}function sn(e){var t=e.targetWindow,n=e.webResponse,r=e.lazyScriptsManager,o=e.updateSerializedPropsCollectionCallback,i=n.assets,a=(void 0===i?{}:i).scripts,s=v((void 0===a?[]:a).reduce((function(e,t){return t.lazyDownload?e[0].push(t):e[1].push(t),e}),[[],[]]),2),c=s[0];return Lt(t,s[1],o).then((function(){return r.handleSubtreeAssets(c)}))}var cn=function(e){var t=e.config,n=e.targetWindow,r=e.unmountNodeCallback,o=e.mountNodeCallback,i=e.updateServicesCallback,a=e.updateAllowedPluginsCallback,s=e.updateSerializedPropsCollectionCallback,c=e.updateComponentNodesCollectionCallback,u=e.updateDebugDataCallback,l=e.injectStylesAndFilters,d=void 0===l?an:l,h=e.injectScripts,f=void 0===h?sn:h,p=e.lazyScriptsManager,v=n.document;function g(e){return H(v,'[data-box-id="'.concat(e,'"]'))}return function(e){var l=e.boxId,h=e.data,m=void 0===h?{}:h,b=e.isPlaceholder,y=m.htmlString,w=void 0===y?"":y,C=m.servicesConfig,E=void 0===C?[]:C,k=m.allowedPlugins,x=void 0===k?[]:k,P=m.debugData;return i(E),a(x),d({targetWindow:n,webResponse:m,config:t}).then((function(){var e=b?function(e){return H(v,'[data-placeholder-for="'.concat(e,'"]'))}(l):g(l);if(r(e),!w)return e.parentNode.removeChild(e),!1;var t=K(v,"div",{innerHTML:w});return e.parentNode.replaceChild(t.firstElementChild,e),!0})).then((function(e){c(),f({targetWindow:n,webResponse:m,lazyScriptsManager:p,updateSerializedPropsCollectionCallback:s}).then((function(){return e&&o(g(l))}))})).then((function(){P&&u(P)}))}},un=function(e){var t=e.config,n=e.targetWindow,r=e.unmountNodeCallback,o=e.mountNodeCallback,i=e.updateServicesCallback,a=e.updateAllowedPluginsCallback,s=e.updateSerializedPropsCollectionCallback,c=e.updateComponentNodesCollectionCallback,u=e.updateDebugDataCallback,l=e.injectStylesAndFilters,d=void 0===l?an:l,h=e.injectScripts,f=void 0===h?sn:h,p=e.lazyScriptsManager,v=e.setFragmentAnalyticsContext,g=e.deleteFragmentAnalyticsContext,m=n.document;function b(e){return H(m,"[".concat(S,'="').concat(e,'"]'))}function y(e,t,n){var r=K(m,"div",{innerHTML:t});return r.setAttribute(S,e),n&&v(r,n),r}return function(e){var l=e.pathname,h=e.data,v=void 0===h?{}:h,w=v.htmlString,C=void 0===w?"":w,E=v.servicesConfig,k=void 0===E?[]:E,x=v.allowedPlugins,P=void 0===x?[]:x,S=v.analyticsContext,I=v.debugData;return i(k),a(P),d({targetWindow:n,webResponse:v,config:t}).then((function(){var e=b(l);if(!e&&C){var t=y(l,C,S);return m.body.appendChild(t),!0}if(e){if(r(e),g(e),!C)return e.parentNode.removeChild(e),!1;var n=y(l,C,S);return e.parentNode.replaceChild(n,e),!0}return!1})).then((function(e){c(),f({targetWindow:n,webResponse:v,lazyScriptsManager:p,updateSerializedPropsCollectionCallback:s}).then((function(){return e&&o(b(l))}))})).then((function(){I&&u(I,!0)}))}},ln=function(e){return e+(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"")},dn=function(){function e(t,n){var r=this;o(this,e),this.observerEntriesHandler=function(e){e.forEach((function(e){if(e.isIntersecting){var t=e.target.dataset,n=t.civ,o=t.prototypeId,i=r.getDependencyMapEntry(o,n),a=ln(o,n);r.isDownloaded(a)||(r.markAsDownloaded(a),r.unobserveAllUnderKey(a),i?Lt(r.targetWindow,i.scripts):r.reportError(new Error('Lazy scripts: Entry not found for "'.concat(o,"@").concat(n,'"'))))}}))},this.onPrototypeRegistered=function(e,t){var n=ln(e,t),o=r.unhandledClicks[n];r.registered.push(n),o&&r.reportError(new Error('Lazy scripts: unhandled click(s) registered for "'.concat(e,"@").concat(t,'" before its script was downloaded.')),{unhandledClicksCount:o})},this.targetWindow=t,this.observedElements={},this.downloaded=[],this.registered=[],this.dependencyMapCache=[],this.observer=null,this.reportError=Mt(t),this.componentNodesFinder=n,this.unhandledClicks={}}return a(e,[{key:"createObserverInstance",value:function(){this.observer||(this.observer=new this.targetWindow.IntersectionObserver(this.observerEntriesHandler,{rootMargin:"800px",threshold:0}))}},{key:"markAsDownloaded",value:function(e){this.downloaded.push(e)}},{key:"isDownloaded",value:function(e){return this.downloaded.includes(e)}},{key:"markAsRegistered",value:function(e){this.registered.push(e)}},{key:"isRegistered",value:function(e){return this.registered.includes(e)}},{key:"observeElement",value:function(e,t){this.observedElements[t]=[].concat(g(this.observedElements[t]||[]),[e]),this.observer.observe(e)}},{key:"unobserveAllUnderKey",value:function(e){var t=this;this.observedElements[e].forEach((function(e){return t.observer.unobserve(e)}))}},{key:"getDependencyMapEntry",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return this.dependencyMapCache.find((function(n){var r=n.prototypeId,o=n.clientImplementationVersion;return r===e&&(void 0===o?"":o)===t}))}},{key:"addDependencies",value:function(e){var t=this;e.forEach((function(e){var n=e.prototypeId,r=e.clientImplementationVersion;t.getDependencyMapEntry(n,r)||t.dependencyMapCache.push(e)}))}},{key:"observeComponents",value:function(e){var t=this;e.forEach((function(e){var n=e.prototypeId,r=e.clientImplementationVersion,o=t.componentNodesFinder.find(n,r);if(o.length){var i=ln(n,r);o.forEach((function(e){t.observeElement(e,i),t.watchForUnhandledClicks(e,i)}))}else t.reportError(new Error('Lazy scripts: DOM reference not found for "'.concat(n,"@").concat(r,'"')))}))}},{key:"filterDownloadedScripts",value:function(e){var t=this;return e.filter((function(e){var n=e.prototypeId,r=e.clientImplementationVersion;return!t.isDownloaded(ln(n,r))}))}},{key:"watchForUnhandledClicks",value:function(e,t){var n=this;ce(e,"click",(function(){n.isRegistered(t)||(n.unhandledClicks[t]=(n.unhandledClicks[t]||0)+1)}))}},{key:"handleSSRAssets",value:function(){var e=this,t=this.targetWindow.document;fe(t,(function(){e.dependencyMapCache=function(e,t){var n=H(e,'script[data-config="lazy-scripts-map"]'),r=[];if(!n)return r;try{return T(pe(n))}catch(e){return t(new Error("Lazy scripts: incorrect dependency map JSON")),r}}(t,e.reportError),U(e.dependencyMapCache)||(e.createObserverInstance(),e.observeComponents(e.dependencyMapCache))}))}},{key:"handleSubtreeAssets",value:function(e){var t=this,n=this.filterDownloadedScripts(e);if(!U(n)){var r=function(e){return O(e.reduce((function(e,t){var n=t.prototypeId,r=t.clientImplementationVersion,o=ln(n,r),i=e[o];return i?(i.scripts.push(t),e):(e[o]={prototypeId:n,clientImplementationVersion:r,scripts:[t]},e)}),{}))}(n);this.addDependencies(r),this.createObserverInstance(),he((function(){return t.observeComponents(r)}))}}}]),e}(),hn=function(){function e(t){o(this,e),this.document=t.document,this.collection=[],this.updateNodesCollection()}return a(e,[{key:"updateNodesCollection",value:function(){this.collection=z(this.document,"div[data-prototype-id]")}},{key:"find",value:function(e,t){return t?this.collection.filter((function(n){return Q(n)===e&&J(n)===t})):this.collection.filter((function(t){return Q(t)===e}))}}]),e}(),fn=function(){function e(){o(this,e),this.listeners=new Map}return a(e,[{key:"addEventListener",value:function(e,t){var n=this.listeners.get(e)||new Set;n.add(t),this.listeners.set(e,n)}},{key:"removeEventListener",value:function(e,t){var n=this.listeners.get(e);n&&(n.delete(t),this.listeners.set(e,n))}},{key:"trigger",value:function(e){var t=this.listeners.get(e.type);t&&t.forEach((function(t){return t(e)}))}}]),e}(),pn=function e(t,n,r){return t.map((function(t){return Object.assign(Object.assign({},t),{},{updatedAt:r,rawParameters:n.resolveAll(t.rawParameters),slots:t.slots.map((function(t){return Object.assign(Object.assign({},t),{},{boxes:e(t.boxes,n,r)})}))})}))},vn=function e(t,n,r){return t.map((function(t){var o=n.get(t.boxId)||n.get(t.name);return Object.assign(Object.assign({},t),{},{updatedAt:o?r:t.updatedAt,rawParameters:o||t.rawParameters,slots:t.slots.map((function(t){return Object.assign(Object.assign({},t),{},{boxes:e(t.boxes,n,r)})}))})}))},gn=function e(t,n){for(var r=!1,o=g(t),i=0;i<o.length;i+=1){var a=o[i];if(a.placeholderFor===n.boxId){r=!0,o[i]=n;break}if(a.slots)for(var s=0;s<a.slots.length;s+=1){var c=e(a.slots[s].boxes,n),u=c.boxes;if(c.hasReplaced){r=!0,a.slots[s].boxes=u,o[i]=a;break}}}return{boxes:o,hasReplaced:r}},mn=a((function e(t){var n=this,r=t.targetWindow,i=t.reportError;o(this,e),this.initialize=function(){var e=n.window.document.getElementById("page-debug-data");if(e){var t=null;try{t=T(pe(e))}catch(e){return n.disableCallbackQueueing(),void n.reportError(new Error("Failed to parse page debug data."))}n.updateData(t,!0),n.initialized=!0,n.eventBus.trigger(new CustomEvent("init",{detail:n.getData()}));var r,o=E(n.queuedStructureChanges);try{for(o.s();!(r=o.n()).done;){(0,r.value)(),n.triggerUpdateEvent()}}catch(e){o.e(e)}finally{o.f()}n.clearQueuedCallbacks()}else n.disableCallbackQueueing()},this.updateData=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e){var r=e.pageDefinition.dataSources.reduce((function(e,t){return Object.assign(Object.assign({},e),{},s({},t.name,t))}),{}),o=new Pe(r);if(e.boxes.length>0){var i=Date.now(),a=pn(e.boxes,o,i);if(t){var c;(c=n.boxes).push.apply(c,g(a))}else{var u=v(a,1)[0],l=gn(n.boxes,u).boxes;n.boxes=l}}if(e.plugins.length>0){var d,h=function(e,t){return e.map((function(e){return Object.assign(Object.assign({},e),{},{parameters:t.resolveAll(e.parameters)})}))}(e.plugins,o),f=E(h);try{for(f.s();!(d=f.n()).done;){var p=d.value,m=n.plugins.get(p.name);m?n.plugins.set(p.name,Object.assign(Object.assign({},m),{},{parameters:p.parameters})):n.plugins.set(p.name,p)}}catch(e){f.e(e)}finally{f.f()}}var b,y=E(e.services);try{for(y.s();!(b=y.n()).done;){var w=b.value;n.services.has(w.name)||n.services.set(w.name,w)}}catch(e){y.e(e)}finally{y.f()}n.initialized||(n.appVersion=e.appVersion,n.pageDefinition=e.pageDefinition,n.appDependencies=e.appDependencies)}},this.onSubtree=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n.execOrQueueStructureChange((function(){n.updateData(e,t)}))},this.onRawDataChange=function(e){n.execOrQueueStructureChange((function(){n.boxes=vn(n.boxes,new Map(N(e.resolvedBoxes)),Date.now())}))},this.execOrQueueStructureChange=function(e){n.initialized?(e(),n.triggerUpdateEvent()):n.allowCallbackQueue&&n.queuedStructureChanges.push(e)},this.getData=function(){return n.initialized?{appDependencies:n.appDependencies,boxes:n.boxes,plugins:j(n.plugins.values()),services:j(n.services.values()),pageDefinition:n.pageDefinition,appVersion:n.appVersion}:null},this.addEventListener=function(e,t){n.eventBus.addEventListener(e,t)},this.removeEventListener=function(e,t){n.eventBus.removeEventListener(e,t)},this.disableCallbackQueueing=function(){n.allowCallbackQueue=!1,n.clearQueuedCallbacks()},this.clearQueuedCallbacks=function(){n.queuedStructureChanges=[]},this.triggerUpdateEvent=function(){n.eventBus.trigger(new CustomEvent("update",{detail:n.getData()}))},this.createAPI=function(){return{get:n.getData,addListener:n.addEventListener,removeListener:n.removeEventListener}},this.window=r,this.initialized=!1,this.reportError=i,this.eventBus=new fn,this.boxes=[],this.plugins=new Map,this.services=new Map,this.appVersion="",this.pageDefinition={edgeHost:"",uploadHost:"",parameters:{},metatags:[],skin:"common",trackingData:{},dataSources:[],failedDataSources:[]},this.appDependencies={vendors:[]},this.allowCallbackQueue=!0,this.queuedStructureChanges=[],fe(this.window.document,(function(){!function(e,t){e.requestAnimationFrame((function(){he(t)}))}(n.window,(function(){return n.initialize()}))}))})),bn="data-placeholder-for",yn=function(){function e(t,n,r){var i=this;o(this,e),this.domReadyHelper=function(e){"loading"===i.document.readyState?fe(i.document,e):i.targetWindow.setTimeout(e,0)},this.lazyloadedElement=function(){var e=q((arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).target,bn);e&&i.opboxWebClient.render.box({boxId:e,isPlaceholder:!0})},this.attach=function(){var e,t,n=Ce(i.targetWindow),r=i.API;n&&(Ft(n,r,(function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];return function(e,t){e[we]=e[we]||{},A(t).forEach((function(n){e[we][n]=t[n]}))}(i.targetWindow,ne.apply(void 0,[n,e].concat(r)))})),e=n,t=A(r).concat("initialized","config"),oe(e,(function(e){return!t.includes(e)})),Object.freeze(n)),i.broadcastAPILoadEvent(),ce(i.targetWindow,"lazyloaded",i.lazyloadedElement),i.updateInlinePreference(),r.performance.markTimeToInteractive("sc-12453")},this.targetWindow=t,this.document=t.document;var a=function(e){return Ce(e).config}(t),s=new Ee({targetWindow:t}),c=new mt({targetWindow:t,config:a}),u=new bt({targetWindow:t}),l=Mt(t),d=new nt({targetWindow:t,config:a,cookieMonsterClient:c,boxViewsMarker:u,reportError:l}),h=new Bt({targetWindow:t,reportError:l}),f=new hn(t),p=new dn(t,f),v=function(e){var t=e.targetWindow,n=e.reportError,r=e.componentNodesFinder,o=new dt(t,n),i=new st(Object.assign(Object.assign({},e),{},{serializedPropsFinder:o}));return{public:Object.assign({init:ht(0,r)},i.createPublicAPI()),private:i.createPrivateAPI()}}({targetWindow:t,services:h,reportError:l,componentNodesFinder:f,registerPrototypeCallback:p.onPrototypeRegistered,unmountNodeCallback:u.unmountNode,mountNodeCallback:u.markBoxAsRendered}),g=new At({reportError:l,allowedPlugins:a.allowedPlugins}),m=new mn({targetWindow:t,reportError:l}),b={config:a,targetWindow:t,unmountNodeCallback:v.private.unmountNode,mountNodeCallback:v.private.mountNode,updateSerializedPropsCollectionCallback:v.private.updateSerializedPropsCollection,updateComponentNodesCollectionCallback:v.private.updateComponentNodesCollection,updateServicesCallback:h.update,updateAllowedPluginsCallback:g.boundUpdateRegistry,updateDebugDataCallback:m.onSubtree,lazyScriptsManager:p,setFragmentAnalyticsContext:d.setFragmentAnalyticsContext,deleteFragmentAnalyticsContext:d.deleteFragmentAnalyticsContext},y=new Ne({config:a,httpClient:n,reportError:l,boxRenderCallback:cn(b),fragmentRenderCallback:un(b)}),w=new Re({appContext:s,analytics:d,debugData:m,updateViewIdCallback:y.updateViewId,updateComponentCallback:v.private.updateComponentCallback,beforeUpdateComponentCallback:v.private.beforeUpdateComponentCallback});this.config=a,this.cookieMonsterClient=c,this.boxViewsMarker=u,this.analytics=d,this.services=h,this.componentAPI=v,this.rawDataListenersRegistry=w,this.opboxWebClient=y,this.plugins=g,this.reportError=l,this.lazyScriptsManager=p,this.debugData=m,this.navigation=new Et({targetWindow:t,opboxWebClient:y,rawDataListenersRegistry:w,reportError:l}),this.edgeClient=new gt({httpClient:r,edgeHost:a.edgeHost,language:a.language}),this.edgeUploadClient=new gt({httpClient:r,edgeHost:a.edgeUploadHost,language:a.language}),this.preferencesClient=new Gt({edgeClient:this.edgeClient,localStorage:t.localStorage,reportError:l}),this.uiTools=function(e){var t=e.document,n=function(e){return B(e)?H(t,'a[name="'.concat(e,'"]')):null},r=function(n){var r=e.pageYOffset||t.documentElement.scrollTop||0;return n?n.getBoundingClientRect().top+r:null};return{getBoxAnchorNode:n,getTopOffset:r,scrollTo:function(t){var o=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).animate,i={duration:void 0===o||o?500:0};if("number"!==L(t)){var a=n(t);if(a){var s=r(a);It(e,s,i)}}else It(e,t,i)},tween:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return St.apply(void 0,[e].concat(n))}}}(t),p.handleSSRAssets(),d.initialize(),this.navigation.initialize(),u.initialize()}return a(e,[{key:"API",get:function(){return{analytics:this.analytics.createAPI(),boxViewsMarker:this.boxViewsMarker.createAPI(),component:this.componentAPI.public,plugin:this.plugins.createAPI(),onData:this.rawDataListenersRegistry.registerListener,changeParams:this.navigation.navigateRelative,refreshPage:this.navigation.refreshPage,tween:this.uiTools.tween,scrollTo:this.uiTools.scrollTo,page:this.opboxWebClient.createAPI(),navigation:this.navigation.createAPI(),edge:this.edgeClient.createAPI(),edgeUpload:this.edgeUploadClient.createAPI(),preferences:this.preferencesClient.createAPI(),onDomReady:this.domReadyHelper,loaded:!0,performance:Ce(this.targetWindow).performance,services:this.services.createAPI(),reportError:this.reportError,__internal__debug:this.debugData.createAPI()}}},{key:"renderBoxForLazyloadedPlaceholders",value:function(){var e=this;j(z(this.document,"[".concat(bn,"].lazyloaded")),(function(t){var n=q(t,bn);return e.opboxWebClient.render.box({boxId:n,isPlaceholder:!0})}))}},{key:"updateInlinePreference",value:function(){var e=this.config,t=this.preferencesClient;e.cssBundle&&e.cssBundle.shouldInline&&t.setPreference("receivedInline",!0)}},{key:"broadcastAPILoadEvent",value:function(){te(this.targetWindow,"opboxAPILoaded")}},{key:"run",value:function(){this.attach(),this.renderBoxForLazyloadedPlaceholders()}}]),e}(),wn=new yn(window,ye(),ye());setTimeout((function(){wn.run()}),0);var Cn=wn.attach,En=2e3,kn=6e3;var xn=Object.freeze({__proto__:null,MIN_ENGAGEMENT_DURATION_IN_MS:En,CYCLE_DURATION_IN_MS:kn,attachEngagementObserver:function(e){var t,n=e.targetWindow,r=e.onCycleComplete,o=Date.now,i=o(),a=function(){return n.innerHeight+(n.scrollY||n.document.documentElement.scrollTop)},s=0,c=0,u=a(),l=null,d=!1,h=function(e,t,n){return e.addEventListener(t,n)},f=function(e){if(l){var t;if(l<s){var n=e-s,r=En-(s-l);t=Math.min(n,r)}else{var o=e-l;t=Math.min(o,En)}c+=t}},p=function(){return o()-i},v=function(){d=!1;var e,t=p();f(t),(e=a())>u&&(u=e),l=t},g=function(){var e,t,o;e=p(),f(e),c>0&&r({engagementTime:Math.min(c,kn),scrollBottom:u,pageHeight:(t=n.document,o=t.body,t.documentElement.scrollHeight||o.scrollHeight)}),l<e-En&&(l=null),c=0,s=e,u=a()},m=n.document;h(m,"click",v),h(m,"mousemove",v),h(m,"keydown",v),h(m,"scroll",(function(){d||(d=!0,n.requestAnimationFrame(v))})),h(n,"pagehide",(function(){n.clearInterval(t),g()})),h(n,"pageshow",(function(){s=p(),t=n.setInterval(g,kn)}))}});return e.attach=Cn,Object.defineProperty(e,"__esModule",{value:!0}),e}({});