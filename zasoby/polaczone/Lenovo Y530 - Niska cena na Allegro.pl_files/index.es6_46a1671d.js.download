const e="survey";var t="other";const i=e=>{if(e)return e.map((({id:e,name:t,alias:i})=>({id:e,name:t,alias:i})))},s=(e,t)=>e?Object.assign({name:e},t?{value:t}:void 0):void 0,n=["isAuthenticated","isInternal","orderId","offerId","purchaseId"],a=["1"],r="surveyQueuedEvents",o=Error("Failed to render survey");class d{constructor({window:e,api:d,props:u}){this.window=void 0,this.api=void 0,this.props=void 0,this.surveyRequested=void 0,this.metadata=void 0,this.surveyInitiationData=void 0,this.getSurveyInitiationData=e=>{const s=(e=>{switch(this.props.device){case"desktop":case"tablet":return"web";case"phone":case"phone-iphone":case"phone-android":return"mweb";case"mobileapp-android":return"android";case"mobileapp-iphone":return"ios";default:return t}})();if(s!==t)return{channelName:s,userLocation:{url:this.window.location.toString(),categoryPath:i(this.props.categoryPath)},customParams:e}},this.requestSurvey=e=>{this.surveyRequested=!0;const t=sessionStorage.getItem(r),i=t?JSON.parse(t):void 0,a=e||i?[...e||[],...i||[]]:void 0,o=((e,t)=>{const i=t?{events:t}:void 0;return Object.assign(Object.assign({},e),i)})(this.props.customParams,a),d=((e,t)=>{const i=[];e&&Object.keys(e).includes("listingType")&&i.push(s("LISTING_VIEW",{listingType:e.listingType}));const n=t||[],a=t||i.length>0?{events:[...n,...i]}:void 0;return Object.assign(Object.assign({},e),a)})(o,a);this.surveyInitiationData=this.getSurveyInitiationData(d),sessionStorage.removeItem(r),this.surveyInitiationData&&this.api.fetchSurveyInitiationData(this.surveyInitiationData,this.props.originLang,this.props.forceLang).then((e=>{if(e&&200===e.status&&e.data){var t;const i=null==(t=e.data.metadata)?void 0:t.language;this.metadata=e.data.metadata,this.showSurvey(e.data.surveyId,i,((e,t)=>{const i=Object.entries(t||{}).filter((([e])=>n.includes(e))).map((([e,t])=>{let i=t;return"string"!=typeof t&&(i=JSON.stringify(t)),{[e]:i}})).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{}),{events:s}=t||{};let a={};return s&&(a=s.filter((e=>null==e?void 0:e.value)).map((e=>e.value)).map((e=>{const t={};for(const[i,s]of Object.entries(e||{}))t[i]="string"==typeof s?s:JSON.stringify(s);return Object.assign(Object.assign({},e),t)})).reduce(((e,t)=>"object"!=typeof t?{}:Object.assign(Object.assign({},e),t)),{})),Object.assign(Object.assign(Object.assign({},e),i),a)})(this.metadata,d),e.data.showDelay,e.data.style)}}))},this.markPresented=e=>{a.includes(e)||this.surveyInitiationData&&this.api.markPresented(e,this.surveyInitiationData)},this.initSurvey=()=>{if(!this.window.document.hidden)return void this.requestSurvey();const e=()=>{"visible"!==document.visibilityState||this.surveyRequested||(this.requestSurvey(),this.window.document.removeEventListener("visibilitychange",e))};this.window.document.addEventListener("visibilitychange",e)},this.showSurvey=(e,t,i,s="0",n="MODAL")=>{setTimeout((()=>{if(null===document.getElementById("ocb-modal")){const a=`${s=this.window.location.host,"SIDEBAR"===n?(e=>{switch(!0){case e.includes("allegro.cz"):case e.includes("allegro.sk"):return"/dotazniky/bocnipanel";case e.includes("allegro.hu"):return"/felmeresek/oldalso-iranyitopult";case e.includes("allegro.com"):return"/surveys/sidebar";default:return"/ankiety/sidebar"}})(s):(e=>{switch(!0){case e.includes("allegro.cz"):return"/dotazniky/modalni";case e.includes("allegro.sk"):return"/dotazniky/modalny";case e.includes("allegro.hu"):return"/felmeresek/modalis";case e.includes("allegro.com"):return"/surveys/modal";default:return"/ankiety/modal"}})(s)}/${e}`;let r=null;"string"==typeof t&&(r={lang:t}),this.metadata=i,this.window.opbox.page.render.fragment(Object.assign({pathname:a},r&&{additionalQueryParameters:r})).catch((()=>{this.window.opbox.reportError(o)}))}var s}),1e3*Number(s))},this.sendEvent=(e,t)=>{const i=s(e,t),n=i?[i]:[];this.requestSurvey(n)},this.sendEvents=e=>{const t=e.map((({name:e,payloadValue:t})=>s(e,t))).filter((e=>void 0===e));this.requestSurvey(t)},this.queueEvent=(e,t)=>{const i=s(e,t);sessionStorage.setItem(r,JSON.stringify([i]))},this.getMetadata=()=>this.metadata,this.window=e,this.props=u,this.api=d,this.surveyRequested=!1,this.initSurvey()}getPublicApi(){return{showSurvey:this.showSurvey,sendEvent:this.sendEvent,sendEvents:this.sendEvents,queueEvent:this.queueEvent,markPresented:this.markPresented,getMetadata:this.getMetadata}}}const u="application/vnd.allegro.internal.v1+json",c={headers:{Accept:u,"Content-Type":u},withCredentials:!0};class h{constructor({window:e}){this.window=void 0,this.retries=0,this.fetchSurveyInitiationData=(e,t,i)=>{const s=new URLSearchParams;let n="/survey/search/byLocation";"boolean"==typeof t&&s.append("origin-lang",t.toString()),"string"==typeof i&&s.append("lang",i);const a=s.toString();return a&&(n+="?"+a),this.window.opbox.edge.post(n,e,c).catch((e=>{this.window.opbox.reportError(e)}))},this.markPresented=(e,t)=>this.window.opbox.edge.post(`/survey/${e}/presented/byLocation`,t,c).then((e=>(this.retries=0,e))).catch((i=>{if(this.window.opbox.reportError(i),this.retries+=1,!(this.retries>3))return new Promise((e=>{setTimeout(e,300*this.retries)})).then((()=>this.markPresented(e,t)))})),this.window=e}}const{surveyConfiguration:l}=(({pluginName:e,clientImplementationVersion:t})=>{try{return JSON.parse(window.document.querySelector(`script[data-serialize-plugin-name="${e}"][data-civ="${t}"]`).textContent)}catch(i){return window.opbox.reportError(Error(`Missing serialized props of plugin "${e}", with civ "${t}"`)),{}}})({pluginName:e,clientImplementationVersion:"005"});if(l&&l.enabled){const t=new h(window);window.opbox.plugin.register({name:e},new d({window,api:t,props:l}).getPublicApi())}
//# sourceMappingURL=index.es6_46a1671d.js.map