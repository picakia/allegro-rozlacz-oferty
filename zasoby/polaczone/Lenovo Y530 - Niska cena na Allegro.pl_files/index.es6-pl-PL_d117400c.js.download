const e="https://a.allegroimg.com/original/3485a6/9f4c0eca45e887fa3c4225bc8680/action-common-heart-filled-c3599c2913";var t="qkEmptyPage",i="qkTitle",s="qkWatchButton",r="qkStar";const o=e=>`[data-role="${e}"]`,a=e=>t=>(t&&(t.style.display=e),t),u=a(""),n=a("none"),h=a("block"),p=e=>({spinner:e.querySelector(o("qkSpinner")),star:e.querySelector(o(r)),link:e.querySelector(o("qkButtonText"))}),l=(e,t)=>{const i=p(e);return i.link.innerHTML=t,u(i.spinner),u(i.star),i};class c{constructor(e,t){this.hidePopover=()=>{this.queriesKeeperUiObject.popover&&(clearTimeout(this.popoverTimeoutId),n(this.infoPopupNode),n(this.queriesKeeperUiObject.popover))},this.hidePopoverLimit=()=>{this.queriesKeeperUiObject.popover&&(clearTimeout(this.limitPopoverTimeoutId),n(this.limitPopupNode),n(this.queriesKeeperUiObject.popover))},this.props=t,this.popoverTimeoutId=null,this.limitPopoverTimeoutId=null,this.timeoutLimit=1e4,this.queriesKeeperUiObject={queriesKeeperArea:e,popover:e.querySelector(o("qkPopup")),queriesKeeperButton:e.querySelector(o(s)),queriesKeeperAllButtons:e.ownerDocument.querySelectorAll(o(s))},this.buttonChildren=p(this.queriesKeeperUiObject.queriesKeeperButton)}enableStar(){this.queriesKeeperUiObject.queriesKeeperAllButtons.forEach((t=>{const{star:i}=l(t,t.dataset.enabledText);i.src=e}))}disableStar(){this.queriesKeeperUiObject.queriesKeeperAllButtons.forEach((e=>{const{star:t}=l(e,e.dataset.disabledText);t.src="https://a.allegroimg.com/original/342704/5df50ccf415c9dc190264897d100/action-common-heart-322d64f02b"}))}showSpinner(){h(this.buttonChildren.spinner),n(this.buttonChildren.star)}hideSpinner(){n(this.buttonChildren.spinner),h(this.buttonChildren.star)}showPopover(){this.queriesKeeperUiObject.popover&&(h(this.infoPopupNode),h(this.queriesKeeperUiObject.popover),this.popoverTimeoutId=setTimeout(this.hidePopover,this.timeoutLimit))}showPopoverLimit(){this.queriesKeeperUiObject.popover&&(h(this.limitPopupNode),h(this.queriesKeeperUiObject.popover),this.limitPopoverTimeoutId=setTimeout(this.hidePopoverLimit,this.timeoutLimit))}isStarEnable(){return this.queriesKeeperUiObject.queriesKeeperButton.querySelector(o(r)).src===e}setQueryIdOnAllButtonsData(e){this.queriesKeeperUiObject.queriesKeeperAllButtons.forEach((t=>{t.setAttribute("data-query-id",e)}))}getQueryIdFromButtonData(){const e=this.queriesKeeperUiObject.queriesKeeperAllButtons[0];return e?e.dataset.queryId:null}get queriesKeeperUi(){return this.queriesKeeperUiObject}get infoPopupNode(){return this.queriesKeeperUiObject.popover.querySelector(o("qkPopupContentInfo"))}get limitPopupNode(){return this.queriesKeeperUiObject.popover.querySelector(o("qkPopupContentLimit"))}}const d=(e,t,i)=>({queryId:t,phrase:e,search:!!e,emptyPage:"LISTING_EMPTY_PAGE"===i,emptySellerPage:"SELLER_LISTING_EMPTY_PAGE"===i});class v{constructor({buttonType:e}){this.buttonType=e}sendOpboxEvent(e,t,i,s){const r=new URL(e).searchParams.get("string")||"";window.opbox.analytics.sendBoxInteractionEvent({customParams:d(r,s,this.buttonType),label:i,contextNode:t,value:e})}}const m=200,q=400,y=401,P=422,b=()=>window.location.href,S=()=>btoa(b());class g{constructor({ui:e,productId:t,urlParams:i,marketplace:s,favoritesPlugin:r}){this.ui=e,this.productId=t,this.urlParams=i,this.marketplace=s,this.favoritesPlugin=r,this.analyticsClient=new v(e.props),this.queryId=null,this.checkRemoteDataStar()}setUrlParams(e){this.urlParams=e}saveQuery(){const{mode:e}=this.favoritesPlugin;return null!==this.productId?this.favoritesPlugin.addFavorite(e.Products,this.productId,{parameters:this.urlParams}):this.favoritesPlugin.addFavorite(e.Queries,S())}checkIsQueryWatched(){const{mode:e}=this.favoritesPlugin;return null!==this.productId?this.favoritesPlugin.checkupFavorite(e.WatchedProductQuery,this.productId,{parameters:this.urlParams}):this.favoritesPlugin.checkupFavorite(e.WatchedQuery,S())}deleteQuery(){return this.favoritesPlugin.removeFavorite(this.favoritesPlugin.mode.Queries,this.queryId)}enableObserveQuery(e){return e||this.analyticsClient.sendOpboxEvent(b(),this.ui.queriesKeeperUi.queriesKeeperButton,"clickAddToWatchQueries",null),this.saveQuery().then((e=>(this.queryId=e.data.id,this.ui.setQueryIdOnAllButtonsData(this.queryId),this.ui.enableStar(),this.ui.showPopover(),this.analyticsClient.sendOpboxEvent(b(),this.ui.queriesKeeperUi.queriesKeeperButton,"addToWatchQueries",this.queryId),!0))).catch((e=>(409===e.status&&(this.analyticsClient.sendOpboxEvent(b(),this.ui.queriesKeeperUi.queriesKeeperButton,"showLimitWatchQueries",null),this.ui.showPopoverLimit()),!1)))}disableObserveQuery(){return null===this.queryId&&(this.queryId=this.ui.getQueryIdFromButtonData()),this.analyticsClient.sendOpboxEvent(b(),this.ui.queriesKeeperUi.queriesKeeperButton,"clickRemoveFromWatchQueries",this.queryId),this.deleteQuery().then((()=>{var e;this.ui.disableStar(),"block"===(null==(e=this.ui.queriesKeeperUi.popover)?void 0:e.style.display)&&this.ui.hidePopover()}))}checkRemoteDataStar(){this.checkIsQueryWatched().then((e=>{[m,q].includes(e.status)?(e.status===m&&(this.queryId=e.data.id,this.ui.setQueryIdOnAllButtonsData(this.queryId)),this.ui.enableStar()):this.ui.disableStar()})).catch((e=>{e&&[y,P].includes(e.status)&&this.ui.disableStar()}))}}class K{constructor(e,s){this.qkService=s,this.ui=s.ui,this.titleWrapper=e.querySelector(o(i)),this.emptyPageWrapper=e.querySelector(o(t)),this.attachWatchButtonListener(),this.attachPopoverListener()}attachWatchButtonListener(){this.ui.queriesKeeperUi.queriesKeeperButton.addEventListener("click",(()=>{this.ui.showSpinner(),this.ui.isStarEnable()?this.qkService.disableObserveQuery().then((()=>{this.ui.hideSpinner()})):this.qkService.enableObserveQuery().then((()=>{this.ui.hideSpinner()}))}))}attachPopoverListener(){const{popover:e}=this.ui.queriesKeeperUi;e&&e.addEventListener("click",(t=>{const i="block"===e.style.display;null!=t.target.closest(o("qkPopupCloseButton"))&&i&&(this.ui.hidePopover(),this.ui.hidePopoverLimit())}))}handleUrlChanges(e={}){const{visible:t=!0,selectedFilters:i}=e;var s;this.emptyPageWrapper&&(this.emptyPageWrapper.style.display=t?"":"none"),this.qkService.setUrlParams(((s=i)&&s.chips||[]).map((e=>e.display.values[0].appliedParameters[0].raw))),this.qkService.checkRemoteDataStar()}}window.opbox.component.register({clientImplementationVersion:"cbe",prototypeName:"allegro.queriesKeeper"},class{constructor({props:e,baseNode:s,pageObj:r=window}){var a=this;this.onPopState=async()=>{(await a.eventListener).qkService.ui.disableStar()},this.props=e,this.plugins=r.opbox.plugin,this.baseNode=s,this.titleBaseNode=s.querySelector(o(i)),this.emptyPageBaseNode=s.querySelector(o(t)),this.eventListener=new Promise((e=>{this.resolveEventListener=e}))}async onMount(){const e=await this.plugins.get("favorites"),t=new c(this.emptyPageBaseNode||this.titleBaseNode,this.props),{props:i}=this,s=new K(this.baseNode,new g({ui:t,productId:i.productId,urlParams:i.urlParams,marketplace:i.marketplace,favoritesPlugin:e}));this.props.resetWatchButtonOnPopState&&window.addEventListener("popstate",this.onPopState),this.resolveEventListener(s)}onUnmount(){this.props.resetWatchButtonOnPopState&&window.removeEventListener("popstate",this.onPopState)}async onUpdate(e){(await this.eventListener).handleUrlChanges(e)}});
//# sourceMappingURL=index.es6-pl-PL_d117400c.js.map