Object.freeze({initialize({modulePath:e=".",importFunctionName:t="__import__"}={}){try{self[t]=Function("u","return import(u)")}catch(r){const s=new URL(e,location),n=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((r,i)=>{const o=new URL(e,s);if(self[t].moduleMap[o])return r(self[t].moduleMap[o]);const a=new Blob([`import * as m from '${o}';`,`${t}.moduleMap['${o}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){i(Error("Failed to import: "+e)),n(l)},onload(){r(self[t].moduleMap[o]),n(l)}});document.head.appendChild(l)})),self[t].moduleMap={}}}}).initialize({modulePath:"https://assets.allegrostatic.com/sc-12453"});const e="metrum-",t="/metrum/",r="data-opbox-fragment-pathname",{assign:s,values:n,keys:i,entries:o}=Object,{from:a}=Array;function l(e){return[].slice.call(e)}const{parse:c,stringify:d}=JSON;function h(e){return Array.isArray(e)}function u(e){return typeof e}function p(e){return"object"===u(e)&&!h(e)&&null!==e}function m(e){return"string"===u(e)}function g(e){return"undefined"===u(e)}function b(e){return"function"===u(e)}function f(e){return null===e||"object"!==u(e)||0===i(e).length}function v(e,t,r){return e?a(e.querySelectorAll(t),r):[]}function C(e,t){return e?e.querySelector(t):null}function y(e,t){return e.hasAttribute(t)}function E(e,t){return e?e.getAttribute(t):null}function w(e){return E(e,"data-prototype-id")}function x(e){return E(e,"data-box-id")}function P(e){return E(e,"data-box-name")}function k(e){return E(e,"data-civ")}function S(e,t,...r){return s(e.createElement(t),...r)}function I(e=""){return e.includes(t)}function A(r){return m(r)?r.split(t)[1].split("/")[0].replace(e,""):""}function N(){}function O(e,t,r){let s;return function(...n){const i=this,o=r&&!s;return clearTimeout(s),s=setTimeout((()=>{s=null,r||e.apply(i,n)}),t),o&&e.apply(i,n),s}}function R(e,t,r={}){const s=new CustomEvent(t,Object.assign({bubbles:!1,cancelable:!0},r));e.dispatchEvent(s)}function j(e,t,...r){if(0===r.length)return t;const[s,...n]=r;return(e="object"!==u(e)?{}:e)[s]=j(e[s],t,...n),e}function V(e,t){return i(e).reduce(((r,s)=>{const n=e[s],i="object"===u(n)?V(n,t):n;return r[t.find((e=>s.toLowerCase()===e.toLowerCase()))||s]=i,r}),{})}function M(e,t=(()=>!1)){i(e).forEach((r=>{({}).hasOwnProperty.call(e,r)&&t(r,e[r])&&delete e[r]}))}const T=/Version\/[\d.]+.*Safari/,B=/iPhone|iPad|iPod|Android/i,D=e=>(t,r)=>Object.assign(Object.assign({},t),e(r)),W=(e,t,r,s)=>e.addEventListener(t,r,{capture:s}),L=(e,t,r)=>e.removeEventListener(t,r),U=()=>Date.now();function F(e){return"noModule"in S(e.document,"script")}function z(e){setTimeout(e,0)}function $(e,t){"loading"===e.readyState?W(e,"DOMContentLoaded",t):t()}function H(e){return e.textContent}const _="Request has been aborted",q=e=>e>=200&&e<=204,Q=(e,t,r,s)=>{const{status:n,response:i,responseType:o}=e,a=t(n),l=(e=>e.split("\n").reduce(((e,t)=>{const r=t.indexOf(":"),s=t.substr(0,r).trim().toLowerCase(),n=t.substr(r+1).trim();return s&&(e[s]=e[s]?`${e[s]}, ${n}`:n),e}),{}))(e.getAllResponseHeaders());let d={};if("blob"===o)d=i;else{const{responseText:t}=e;try{d=c(t)}catch(h){d=t}}a?r({status:n,data:d,headers:l}):s({status:n,data:d,message:"Request failed with status code "+n,headers:l})};var G=()=>{let e=null;const t=(t,r,s,{headers:n={},validateStatus:o=q,withCredentials:a=!1,cancelLast:l=!1,onUploadProgress:c,responseType:h="",signal:p})=>{if(l&&(console.log("You are using deprecated option that will be removed in next major version of opbox-web-browser. Consider using signal option instead"),null!==e&&e.abort()),p&&p.aborted)return Promise.reject(Error(_));const m=((e,t,r,s,n,o)=>{const a=new XMLHttpRequest;return a.open(e,t,!0),i(r).forEach((e=>{a.setRequestHeader(e,r[e])})),a.withCredentials=s,a.responseType=o,a.upload&&n&&W(a.upload,"progress",n),a})(t,r,n,a,c,h);e=m;const g=((e,t,r)=>new Promise(((s,n)=>{function i(){Q(e,t,s,n),l()}function o(){Q(e,t,s,n),l()}function a(){e.abort(),n(Error("Request has been aborted")),l()}function l(){L(e,"load",i),L(e,"error",o),r&&L(r,"abort",a)}W(e,"load",i),W(e,"error",o),r&&W(r,"abort",a)})))(m,o,p).finally((()=>{e=null}));return((e,t,r)=>{e.send(((e,t)=>["POST","PUT","PATCH"].includes(e)?"object"!==u(t)||t instanceof Blob||t instanceof FormData?t:d(t):null)(t,r))})(m,t,s),g};return{request:t,get(e,r={}){return t("GET",e,{},r)},post(e,r,s){return t("POST",e,r,s)},put(e,r,s){return t("PUT",e,r,s)},patch(e,r,s){return t("PATCH",e,r,s)},delete(e,r={}){return t("DELETE",e,{},r)}}};const J="opbox",Y=e=>e[J]||{};class K{constructor({targetWindow:e}={}){this.targetWindow=e}get document(){return this.targetWindow.document}}class X extends Error{constructor(e){super(e),this.message=e,this.name="PageRenderingError"}}class Z{constructor({data:e,headers:t}={}){this.data=e,this.headers=t}get valid(){return p(this.data)}}class ee{constructor(e={}){this.dataSources=e}resolve(e,t){const{value:r}=e;if("DATA_SOURCE"===e.type){const e=this.dataSources[r];return Object.assign(Object.assign({},e&&e.data&&{[t]:e.data}),e&&!f(e.metadata)&&{[t+".$meta"]:e.metadata})}return{[t]:r}}resolveAll(e){return i(e).reduce(((t,r)=>Object.assign(Object.assign({},t),this.resolve(e[r],r))),{})}}class te{constructor({boxes:e={},boxNameToIdMap:t={},dataSources:r={},meta:s={}}={}){this.boxes=e,this.boxNameToIdMap=t,this.dataSources=r,this.meta=s,this.parameterResolver=new ee(r)}get resolved(){return{boxes:this.resolvedBoxes,boxNameToIdMap:this.boxNameToIdMap,dataSources:this.dataSources,meta:this.meta}}get resolvedBoxes(){const{pageProperties:e}=this;return function(e=this,t,r){const s={};return i(e).forEach((n=>{s[n]=t.call(r,e[n],n,e)})),s}(this.boxes,(t=>{const r=i(t).reduce(((e,r)=>{const n=this.parameterResolver.resolve(t[r],r);return s(e,n)}),{});return s(r,e)}))}get pageProperties(){const e={};for(const t in this.meta)0===t.indexOf("$page.")&&(e[t]=this.meta[t]);return e}}function re({href:e},t={}){const r=new URL(e);return r.search=((e,t)=>{const r=new URLSearchParams(e.search);return o(t).map((([e,t])=>(h(t)?(r.delete(e),t.forEach((t=>r.append(e,t)))):r.set(e,t),r))),r})(r,t).toString(),r.toString()}const se="application/vnd.opbox-web.subtree+json";function ne(e){return e>=200&&e<300||502===e}class ie{constructor({targetWindow:e=window,config:t={},httpClient:r,reportError:s,fragmentRenderCallback:n,boxRenderCallback:i}){this.updateViewId=e=>{this.viewId=e},this.renderSubtree=({boxId:e,additionalQueryParameters:t={},isPlaceholder:r=!1}={})=>(this.targetWindow.console.warn("Warning: renderSubtree method is deprecated and will be removed soon. Use render.box method instead."),this.renderBox({boxId:e,additionalQueryParameters:t,isPlaceholder:r})),this.httpClient=r,this.reportError=s,this.targetWindow=e,this.fragmentRenderCallback=n,this.boxRenderCallback=i,this.render={box:this.renderBox.bind(this),fragment:this.renderFragment.bind(this)},this.viewId=t.viewId,this.getPageDataAbortController=new AbortController}getPageData(e){this.getPageDataAbortController.abort(),this.getPageDataAbortController=new AbortController;const t={headers:{Accept:"application/vnd.opbox-web.v2+json"},validateStatus:ne,signal:this.getPageDataAbortController.signal};return this.httpClient.get(e,t).then((e=>{const t=new Z(e);if(!t.valid)throw new X("Opbox response is invalid.");return new te(t.data)}))}handleError(e){return this.reportError(Error(e)),Promise.reject(e)}renderBox({boxId:e,additionalQueryParameters:t={},isPlaceholder:r=!1}={}){return e?this.httpClient.get(re(this.targetWindow.location,t),{headers:{Accept:se,"x-box-id":e,"x-view-id":this.viewId},validateStatus:ne}).then((({data:t})=>this.boxRenderCallback({boxId:e,data:t,isPlaceholder:r}))):this.handleError("Missing 'boxId' property!")}renderFragment({pathname:e,additionalQueryParameters:t={}}={}){if(!e)return this.handleError("Missing 'pathname' property!");if(!(e=>!!e.match(RegExp("^(\\/[a-zA-Z0-9\\-]+)*\\/{0,1}$")))(e))return this.handleError("Invalid 'pathname' property!");const{protocol:r,host:s}=this.targetWindow.location,{href:n}=new URL(`${r}//${s}${e}`);return this.httpClient.get(re({href:n},t),{headers:{Accept:se,"x-view-id":this.viewId},validateStatus:ne}).then((({data:t})=>this.fragmentRenderCallback({pathname:e,data:t})))}createAPI(){return{renderSubtree:this.renderSubtree,render:this.render}}}class oe{constructor({meta:e={}}={},t){this.appContext=t,this.meta=e}updateMetaRobots(){const e=C(this.appContext.document,'head meta[name="robots"]');e&&this.meta&&e.setAttribute("content",[this.meta.noindexCondition?"noindex":"index",this.meta.nofollowCondition?"nofollow":"follow"].join(", "))}render(){this.updateMetaRobots()}}class ae{constructor({appContext:e,analytics:t,debugData:r,updateViewIdCallback:s,updateComponentCallback:n=N,beforeUpdateComponentCallback:i=N}){this.registerListener=(e,t=N,r=N)=>{if(this.rawData.boxes[e]){const r=this.rawData.resolved.boxes[e];setTimeout((()=>{t(r)}),0)}this.listeners[e]={onChange:t,onProgress:r}},this.appContext=e,this.rawData=new te,this.debugData=r,this.listeners={},this.analytics=t,this.updateViewIdCallback=s,this.updateComponentCallback=n,this.beforeUpdateComponentCallback=i}triggerChangeListener(e){this.rawData=e;const{boxes:t,boxNameToIdMap:r,meta:s}=this.rawData.resolved,{defaultCustomParams:n,viewId:a}=s;this.analytics&&this.analytics.updateCustomParams(n,a),this.updateViewIdCallback&&this.updateViewIdCallback(a),o(t).forEach((([e,t])=>{g(t)||this.updateComponentCallback(e,t)})),i(r).forEach((e=>{const s=t[r[e]];if(!g(s)){const t=this.listeners[e];t&&b(t.onChange)&&setTimeout((()=>t.onChange(s)),0)}})),new oe({meta:s},this.appContext).render(),this.debugData&&this.debugData.onRawDataChange(this.rawData)}triggerProgressListener(){this.beforeUpdateComponentCallback(),i(this.listeners).forEach((e=>{const t=this.listeners[e];t&&b(t.onProgress)&&setTimeout((()=>t.onProgress()),0)}))}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var le={exports:{}};le.exports=(()=>{function e(e){return e instanceof Object&&e.constructor===Object}function t(r,s){var n=r,i=s;e(r)||(n={}),e(s)||(i={});var o=Object.keys(n),a=Object.keys(i),l={};return o.forEach((r=>{-1!==a.indexOf(r)?null===n[r]?l[r]=i[r]:e(n[r])&&e(i[r])?l[r]=t(n[r],i[r]):l[r]=i[r]:l[r]=n[r]})),a.forEach((e=>{-1===o.indexOf(e)&&(l[e]=i[e])})),l}return function(r){var s=r;e(r)||(s={});for(var n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return i.forEach((r=>{e(r)&&(s=t(s,r))})),s}})();var ce=le.exports;const de=new WeakMap,he=new WeakMap,ue=new WeakMap,pe="data-analytics-enabled",me=e=>v(e,`[${pe}]`),ge=e=>{const t=v(e,"[data-analytics-proxied]").reduce(((e,t)=>{const r=me(t).filter((t=>!e.includes(t)));return r.length?(s=r,e.concat(s)):e;var s}),[]);return me(e).filter((e=>!t.includes(e)))},be=e=>he.has(e),fe=(e,t,r=0)=>{if(!e||be(e))return;const s=(parseInt(ue.get(e),10)||0)+t;s>=r&&(he.set(e,!0),R(e,"boxView",{bubbles:!0})),ue.set(e,s)},ve=(e,t,r,s)=>{const n={lowerValue:e,higherValue:t,viewportDimension:r,overrideLength:s};return de.has(n)||de.set(n,e>0?e<r?t<r?t-e:r-e:0:t<0?0:t<r?t:e<=0&&t>=r?r:s),de.get(n)},Ce="data-analytics-tags",ye="data-item",Ee=e=>e.replace(/^([A-Z])|[\s|_-](\w)/g,((e,t,r)=>r?r.toUpperCase():t.toLowerCase())),we=({contextNode:e,stringParamCustomPrefix:t,jsonParamCustomPrefix:r,reportError:s=(()=>{})})=>{const n={};for(let o=0;o<e.attributes.length;o+=1){const a=e.attributes[o];if(t&&a.name.startsWith(t)){const e=a.name.replace(t,"");n[Ee(e)]=a.value}if(r&&a.name.startsWith(r)){const e=a.name.replace(r,"");try{n[Ee(e)]=c(a.value)}catch(i){s(Error(`An error "${i.message}" occurred while extracting custom parameters from attributes`))}}}return n},xe=(e={},t,r)=>t?ce(e,{renderedColorScheme:r},{_opbox:{viewId:t}}):e,Pe=({contextNode:e,customParams:t={},reportError:r})=>{const s=we({contextNode:e,stringParamCustomPrefix:"data-analytics-view-opbox-custom-"}),n=i(s).length?{_opbox:s}:{};return ce(we({contextNode:e,stringParamCustomPrefix:"data-analytics-view-custom-",jsonParamCustomPrefix:"data-analytics-view-json-custom-",reportError:r}),n,t)},ke=({contextNode:e,coordinates:t={},destinationUrl:r="",customParams:s={},isNewTab:n})=>{const i=n?{isNewTab:n}:{},o=Object.assign(Object.assign(Object.assign({},we({contextNode:e,stringParamCustomPrefix:"data-analytics-click-opbox-custom-"})),{},{destinationUrl:r},i),t);return ce(we({contextNode:e,stringParamCustomPrefix:"data-analytics-click-custom-",jsonParamCustomPrefix:"data-analytics-click-json-custom-"}),{_opbox:o},s)},Se=({contextNode:e,customParams:t={}})=>{const r=we({contextNode:e,stringParamCustomPrefix:"data-analytics-interaction-custom-",jsonParamCustomPrefix:"data-analytics-interaction-json-custom-"}),s=we({contextNode:e,stringParamCustomPrefix:"data-analytics-interaction-opbox-custom-"}),n=i(s).length?{_opbox:s}:{};return ce(r,n,t)},Ie=(e,t)=>t&&e.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",Ae=(e,t,r,s)=>(W(e,t,r,s),()=>{L(e,t,r)});class Ne{constructor({targetWindow:e,config:t,cookieMonsterClient:r,boxViewsMarker:s,reportError:n}){this.sendPingEvent=({engagementTime:e,scrollBottom:t,pageHeight:r}={})=>{const s={category:"Engagement",label:"ping",customParams:{et:e,sb:t,ph:r}};this.cookieMonsterClient.send("event",s),this.callEventCallbacks(s)},this.detectAdblock=()=>{const{document:e}=this,t=S(e,"div",{innerHTML:"&nbsp;",className:"adsbox"});e.body.appendChild(t),this.targetWindow.setTimeout((()=>{const r=0!==t.offsetHeight;this.cookieMonsterClient.send("event",{category:"clearPV",action:r,customParams:this.defaultCustomParams.ev}),e.body.removeChild(t)}),100)},this.handleClick=e=>{this.handleBoxInteraction(e),this.handleLinkClick(e)},this.handleLinkClick=e=>{if(!b(e.target.closest))return;if(this.shouldHandleBoxInteraction(e))return void this.handleBoxInteraction(e);const t=e.target.closest("a");if(!t||!y(t,"data-analytics-clickable"))return;const r=E(t,"data-analytics-click-label")||"",s=E(t,"data-analytics-click-value")||H(t).trim(),n="_blank"===E(t,"target"),i=E(t,"href"),o=e.pageX?{pageX:e.pageX,pageY:e.pageY}:{};"click"!==e.type||0!==e.button?"contextmenu"!==e.type?"mousedown"===e.type&&1===e.button&&this.sendClickEvent({contextNode:t,label:r,value:s,customParams:ke({contextNode:t,coordinates:o,destinationUrl:i,isNewTab:!0})}):this.sendContextmenuEvent({contextNode:t,label:r,value:s,customParams:ke({contextNode:t,coordinates:o,destinationUrl:i})}):this.sendClickEvent({contextNode:t,label:r,value:s,customParams:ke({contextNode:t,coordinates:o,destinationUrl:i,isNewTab:n||e.metaKey||e.ctrlKey})})},this.handleChange=e=>{const t=e.target;if("select-one"===t.type&&t&&y(t,"data-analytics-selectable")){const{value:e}=t.options[t.selectedIndex],r=we({contextNode:t,stringParamCustomPrefix:"data-analytics-select-custom-"});this.sendEvent({contextNode:t,action:"change",value:e,customParams:r})}},this.handleSubmit=e=>{const t=e.target;if(!t||"FORM"!==t.nodeName||!y(t,"data-analytics-submittable"))return;const r=E(t,"action");let s=a(t.elements).filter((e=>e.name)).map((e=>({name:e.name,value:e.value}))).sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))).map((e=>`${e.name}=${e.value}`)).join("&");s=s?"?"+s:"";let n=s?r+s:r;n=encodeURI(n),this.sendFormSubmitEvent({contextNode:t,value:n,label:"submitForm"})},this.handleBoxView=e=>{const t=e.target;if(!t||!y(t,"data-analytics-enabled")||a(t.childNodes).some((e=>e.classList&&e.classList.contains("opbox-fragment"))))return;const r=E(t,"data-analytics-view-value")||"",s=E(t,"data-analytics-view-label")||"";let n=Pe({contextNode:t,reportError:this.reportError});if(t.firstChild&&t.firstChild.nodeType===Node.ELEMENT_NODE&&(n=Object.assign(Object.assign({},n),we({contextNode:t.firstChild,stringParamCustomPrefix:"data-analytics-view-custom-"}))),y(t,ye))return this.markParentBoxAsVisible(t),void this.sendItemViewEvent({contextNode:t,label:s,value:r,customParams:n});n=Object.assign(Object.assign({},n),(e=>{if(!e)return{};const t=E(e,"data-analytics-box-view-custom-params");if(!t)return{};let r={};try{r=c(decodeURIComponent(t))}catch(s){console.log(s)}return r})(t)),this.sendBoxViewEvent({contextNode:t,value:r,customParams:n})},this.setFragmentAnalyticsContext=(e,t)=>this.fragmentCustomParams.set(e,t),this.deleteFragmentAnalyticsContext=e=>this.fragmentCustomParams.delete(e);const{cookieMonster:{account:i,isEngagementMeasuringEnabled:o,defaultCustomParams:l={}}={},isDarkModeEnabled:d,viewId:h}=t;this.targetWindow=e,this.document=e.document,this.account=i,this.isEngagementMeasuringEnabled=o,this.cookieMonsterClient=r,this.boxViewsMarker=s,this.reportError=n,this.defaultCustomParams=l,this.fragmentCustomParams=new WeakMap,this.isDarkModeEnabled=d,this.viewId=h,this.eventCallbacks=[];const u=(({navigator:{userAgent:e=""}={}}={})=>e)(e);this.isMobile=(e=>!!e.match(B))(u),this.isSafari=(e=>!!e.match(T))(u),this.isFirefox=(e=>e.toLowerCase().includes("firefox"))(u)}initialize(){if(!this.account)return;this.cookieMonsterClient.initialize(),this.isEngagementMeasuringEnabled&&__import__("./engagement-observer-49c7d01bb.js").then((({attachEngagementObserver:e})=>{e({targetWindow:this.targetWindow,onCycleComplete:this.sendPingEvent})}));const{document:e}=this;this.eventHandlers=[Ae(e,"change",this.handleChange),Ae(e,"click",this.handleClick,!0),Ae(e,"mousedown",this.handleLinkClick),Ae(e,"submit",this.handleSubmit),Ae(e,"contextmenu",this.handleClick),Ae(e,"boxView",this.handleBoxView),Ae(this.targetWindow,"DOMContentLoaded",this.detectAdblock)]}teardown(){this.eventHandlers.forEach((e=>{e()}))}callEventCallbacks(e){this.eventCallbacks.length&&this.eventCallbacks.forEach((t=>t(e)))}sendEvent({contextNode:e,action:t,label:s="",value:n,customParams:i={}}={}){if(!e||!t)return{};const o=e.closest("[data-analytics-category]").getAttribute("data-analytics-category"),a=P(e.closest("[data-box-name]")),l=e.closest("[data-box-id]"),d=e.closest(`[${r}]`),h=l&&x(l),u=(e=>{const t=e.closest(`[${Ce}]`);return t?((e,t)=>{const r=e.split(","),s=t.split(","),n=r.concat(s);return n.filter(((e,t)=>e&&n.indexOf(e)===t))})(t.closest(`[${ye}]`)?(e=>{const t=e&&e.closest(`[data-box-name][${Ce}]`);return t&&E(t,Ce)||""})(t):"",E(t,Ce)||""):[]})(e),p=(e=>{const t=e.closest("[data-analytics-groups]");if(t){let e=decodeURIComponent(E(t,"data-analytics-groups"));try{e=c(e)}catch(r){return console.log(`JSON.parse error! Can not convert ${e} to JSON.`),[]}return e}return[]})(e),m=u.length?{analyticsTags:u}:{},g=p.length?{groups:p}:{},b=h?{boxName:a,boxId:h}:{boxName:a},f=Object.assign(Object.assign(Object.assign({},m),g),b),v={category:o,action:t,label:s,value:n,customParams:ce(Object.assign({},i),{_opbox:f},this.defaultCustomParams.ev,this.getFragmentAnalyticsContext(d))};return this.cookieMonsterClient.send("event",v),this.callEventCallbacks(v),v}sendClickEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"click"}))}sendContextmenuEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"contextmenu"}))}sendBoxInteractionEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"boxInteraction"}))}sendItemViewEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"itemView"}))}sendBoxViewEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"boxView"}))}sendFormSubmitEvent(e){this.sendEvent(Object.assign(Object.assign({},e),{},{action:"submit"}))}handleBoxInteraction(e){if(!b(e.target.closest))return;const t=e.target.closest("[data-analytics-interaction]");if(!t)return;const r=Se({contextNode:t}),s=E(t,"data-analytics-interaction-label")||"",n=E(t,"data-analytics-interaction-value")||H(t).trim();this.sendBoxInteractionEvent({contextNode:t,label:s,value:n,customParams:r})}shouldHandleBoxInteraction(e){return"mousedown"===e.type&&!this.isMobile&&(this.isSafari||this.isFirefox)&&"select-one"===e.target.type}markParentBoxAsVisible(e){const t=e.parentNode&&e.parentNode.closest("[data-analytics-enabled]");this.boxViewsMarker&&t&&!be(t)&&this.boxViewsMarker.markBoxAsVisible(t,!0)}sendPageViewProxy(){this.account&&(this.cookieMonsterClient.sendPageView(xe(this.defaultCustomParams.pv,this.viewId,Ie(this.targetWindow,this.isDarkModeEnabled))),this.cookieMonsterClient.updateReferrer())}sendEventProxy(e,t,r,s,n){return this.account?e.nodeType===Node.ELEMENT_NODE?this.sendEvent({value:r,label:n,action:t,contextNode:e,customParams:s}):this.sendEvent(e):null}sendItemViewEventProxy({contextNode:e,label:t,value:r,customParams:s}){this.account&&this.sendItemViewEvent({contextNode:e,label:t,value:r,customParams:Pe({contextNode:e,customParams:s,reportError:this.reportError})})}sendClickEventProxy({contextNode:e,label:t,value:r,customParams:s,destinationUrl:n,isNewTab:i}){if(this.account){if(i&&"boolean"!==u(i))throw Error("isNewTab property must be boolean");this.sendClickEvent({contextNode:e,label:t,value:r,customParams:ke({contextNode:e,destinationUrl:n,customParams:s,isNewTab:i})})}}sendContextmenuEventProxy({contextNode:e,label:t,value:r,customParams:s,destinationUrl:n}){this.account&&this.sendContextmenuEvent({contextNode:e,label:t,value:r,customParams:ke({contextNode:e,destinationUrl:n,customParams:s})})}sendBoxInteractionEventProxy({contextNode:e,label:t,value:r,customParams:s}){this.account&&this.sendBoxInteractionEvent({contextNode:e,label:t,value:r,customParams:Se({contextNode:e,customParams:s})})}updateCustomParams({pv:e={},ev:t={}}={},r){this.viewId=r,p(e)&&p(t)?this.defaultCustomParams={pv:e,ev:t}:console.log("Can not update custom params with non-object arguments!")}registerEventCallback(e){this.account&&e&&!this.eventCallbacks.includes(e)&&this.eventCallbacks.push(e)}getFragmentAnalyticsContext(e){return this.fragmentCustomParams.get(e)||{}}createAPI(){return{sendPageView:this.sendPageViewProxy.bind(this),sendEvent:this.sendEventProxy.bind(this),sendItemViewEvent:this.sendItemViewEventProxy.bind(this),sendClickEvent:this.sendClickEventProxy.bind(this),sendContextmenuEvent:this.sendContextmenuEventProxy.bind(this),sendBoxInteractionEvent:this.sendBoxInteractionEventProxy.bind(this),registerEventCallback:this.registerEventCallback.bind(this)}}}function Oe(e){return p(e)&&!("clientImplementationVersion"in e)?s(e,{clientImplementationVersion:""}):e}function Re({instance:e,method:t,reportError:r,data:s=null,onSuccess:n=(()=>{})}){if(e&&b(e[t]))try{e[t](s),n()}catch(i){r(Error(`There was some problem executing "${t}" method on box instance: ${i.message}`))}}function je(e,t){return""===t?e:`${e}@${t}`}class Ve{constructor({targetWindow:e,services:t,reportError:r,unmountNodeCallback:s,mountNodeCallback:n,componentNodesFinder:i,serializedPropsFinder:o,registerPrototypeCallback:a}={}){this.unmountNode=e=>{this.unmountNodeCallback(e),v(e,"div[data-prototype-id]").concat([e]).forEach((e=>{const t=x(e)||P(e);Re({instance:this.instances.get(t),method:"onUnmount",reportError:this.reportError}),this.instances.set(t,null)}))},this.mountNode=e=>{v(e,"div[data-prototype-id]").concat([e]).forEach((e=>{const t=w(e),r=k(e)||"";this.registerInstancesForPrototype(t,r,[e])})),this.mountNodeCallback(e)},this.updateComponentCallback=(e,t)=>{const r=this.instances.get(e);r?z((()=>{Re({instance:r,method:"onUpdate",reportError:this.reportError,data:t})})):this.boxDataCache.set(e,t)},this.beforeUpdateComponentCallback=()=>{this.instances.forEach((e=>Re({instance:e,method:"beforeOnUpdate",reportError:this.reportError})))},this.register=(e,t)=>{const r=(e=>h(e)?e.map(Oe):Oe(e))(e);this.isPrototypeValid(r)&&this.isImplementationValid(t)&&(h(r)?r.forEach((e=>{this.registerImplementationAndInstances(e,t)})):this.registerImplementationAndInstances(r,t))},this.targetWindow=e,this.services=t,this.implementations=new Map,this.instances=new Map,this.boxDataCache=new Map,this.reportError=r,this.unmountNodeCallback=s,this.mountNodeCallback=n,this.registerPrototypeCallback=a,this.serializedPropsFinder=o,this.componentNodesFinder=i}isPrototypeObjectValid(e){const{prototypeName:t,clientImplementationVersion:r}=e;return"prototypeName"in e?""===t?(this.reportError(Error('Property "prototypeName" cannot be empty string')),!1):m(t)?!!m(r)||(this.reportError(Error('Property "clientImplementationVersion" must be string but got '+u(r))),!1):(this.reportError(Error('Property "prototypeName" must be string but got '+u(t))),!1):(this.reportError(Error('Property "handledPrototype" must have "prototypeName" field')),!1)}containsValidPrototypes(e){return 0===e.length?(this.reportError(Error("Empty handledPrototypes list")),!1):!e.filter((e=>!this.isPrototypeObjectValid(e))).length}isPrototypeValid(e){return h(e)?this.containsValidPrototypes(e):p(e)?this.isPrototypeObjectValid(e):(this.reportError(Error('"handledPrototype" argument must be an object or an array')),!1)}isImplementationValid(e){return b(e)?e.prototype.onUpdate&&!b(e.prototype.onUpdate)?(this.reportError(Error('"onUpdate" property must be a function or undefined but got '+u(e.prototype.onUpdate))),!1):!!b(e.prototype.onMount)||(this.reportError(Error('"implementation" class has to have "onMount" method')),!1):(this.reportError(Error('"implementation" must be a class')),!1)}registerInstancesForPrototype(e,t,r){const s=this.implementations.get(je(e,t));s&&(this.registerInstances(r,this.services.getServicesForComponent(e),s),this.registerPrototypeCallback(e,t))}registerImplementationAndInstances({prototypeName:e,clientImplementationVersion:t},r){const s=je(e,t),n=""===t;this.implementations.has(s)?this.reportError(Error(`${e} ${n?"":`with ${t} client implementation version `}already registered!`)):(this.implementations.set(s,r),this.registerInstancesForPrototype(e,t,this.componentNodesFinder.find(e,t)))}registerInstances(e,t,s){e.forEach((e=>{if(E(e,r))return;const n=P(e),i=x(e),o=this.serializedPropsFinder.getPropsForBox(i,n),a=new s({baseNode:e,props:o,services:t}),l=i||n;z((()=>{this.instances.get(l)||(Re({instance:a,method:"onMount",reportError:this.reportError,onSuccess:()=>{this.instances.set(l,a)}}),this.boxDataCache.has(l)&&(Re({instance:a,method:"beforeOnUpdate",reportError:this.reportError}),this.updateComponentCallback(l,this.boxDataCache.get(l)),this.boxDataCache.delete(l)))}))}))}createPublicAPI(){return{register:this.register}}createPrivateAPI(){return{updateComponentCallback:this.updateComponentCallback,beforeUpdateComponentCallback:this.beforeUpdateComponentCallback,unmountNode:this.unmountNode,mountNode:this.mountNode,updateSerializedPropsCollection:()=>{this.serializedPropsFinder.updateNodesCollection()},updateComponentNodesCollection:()=>{this.componentNodesFinder.updateNodesCollection()}}}}const Me="data-serialize-box-id",Te="data-serialize-box-name",Be=`script[${Me}], script[${Te}]`;class De{constructor(e,t){this.targetWindow=e,this.reportError=t,this.collection=[],this.updateNodesCollection()}updateNodesCollection(){this.collection=v(this.targetWindow.document,Be)}getNodeByBoxId(e){return this.collection.find((t=>E(t,Me)===e))}getNodeByBoxName(e){return this.collection.find((t=>E(t,Te)===e))}getPropsFromNode(e){if(!e)return{};try{return c(H(e))}catch(t){return this.reportError(t),{}}}getPropsForBox(e,t){const r=this.getNodeByBoxId(e)||this.getNodeByBoxName(t);return r?this.getPropsFromNode(r):{}}}const We=(e,t)=>({prototypeName:e},r)=>{e&&r({domNodes:t.find(e)})};function Le(e,t){if(null==e)return{};var r,s,n=((e,t)=>{if(null==e)return{};var r,s,n={},i=Object.keys(e);for(s=0;s<i.length;s++)r=i[s],t.indexOf(r)>=0||(n[r]=e[r]);return n})(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)r=i[s],t.indexOf(r)>=0||{}.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}const Ue=["Content-Type"],Fe=()=>Promise.reject(Error("missing edge host")),ze="application/vnd.allegro.public.v1+json";class $e{constructor({httpClient:e,edgeHost:t,language:r}){this.get=(e,t)=>this.httpClient.get(this.prepareRequestUrl(e),this.prepareRequestSettings(t,!0)),this.put=(e,t,r)=>this.httpClient.put(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r)),this.post=(e,t,r)=>this.httpClient.post(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r)),this.patch=(e,t,r)=>this.httpClient.patch(this.prepareRequestUrl(e),t,this.prepareRequestSettings(r)),this.delete=(e,t)=>this.httpClient.delete(this.prepareRequestUrl(e),this.prepareRequestSettings(t,!0)),this.edgeHost=t,this.httpClient=e,this.defaultHeaders={"Content-Type":ze,Accept:ze,"Accept-Language":r}}prepareRequestSettings(e={},t=!1){if(e.disableDefaultHeaders)return e;const r=this.normalizeSettings(e),s=Le(this.defaultHeaders,Ue);return ce({},t?{headers:s}:{headers:this.defaultHeaders},r)}normalizeSettings(e){if(!e||!e.headers)return e;const t=V(e.headers,i(this.defaultHeaders));return s(e,{headers:t})}prepareRequestUrl(e){return this.edgeHost+e}createAPI(){return this.edgeHost?{get:this.get,put:this.put,post:this.post,patch:this.patch,delete:this.delete}:{get:Fe,put:Fe,post:Fe,patch:Fe,delete:Fe}}}function He({targetWindow:e,alias:t="cm",config:r={}}){const{cookieMonster:{host:s,account:n,encodedUserId:o,defaultCustomParams:a={}},viewId:c,isDarkModeEnabled:d}=r,{document:h}=e,u=()=>b(e[t]);function p(){u()&&e[t].apply(null,l(arguments))}function m(){const e="send@"+n;p.apply(null,[e].concat(l(arguments)))}let g;const f=(t=xe(a.pv,c,Ie(e,d)))=>{m("pageview",{customParams:t,referrer:g})},v=()=>{g=window.location.href},C={initialize(){s&&n&&!u()?((()=>{if(!u()){e["cm.analytics.object"]=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(l(arguments))};{const e="script",t=h.createElement(e);t.src=s,h.head.appendChild(t)}}})(),p("create",n,{userId:o}),f(),v()):v()},updateReferrer:v,send:m,sendPageView:f};i(C).forEach((e=>{this[e]=C[e]}))}class _e{constructor({targetWindow:e,boxes:t=[],significantElementSizePercentage:r=.75,significantElementSizeForBiggerThanViewportPercentage:s=.5,timeoutValue:n=500,debounceTimeoutValue:i=20}){this.markCurrentlyVisibleElementsAsSeen=()=>{const{timeoutValue:e}=this.config;this.visibleElements.forEach((t=>{fe(t,e,e)}))},this.markPreviouslyVisibleElementAsHidden=e=>{this.visibleElementsByIntersectionObserver.has(e)&&(this.visibleElementsByIntersectionObserver.delete(e),R(e,"outOfViewport"))},this.intersectionHandler=e=>{e.forEach((({target:e,boundingClientRect:t,rootBounds:r})=>{r&&((e,t,r,s)=>{const n=e.right-e.left,i=e.bottom-e.top,o=t.height,a=t.width,l=((e,t)=>(e.top>=t.top&&e.top<=t.bottom||e.bottom<=t.bottom&&e.bottom>=t.top||e.top<t.top&&e.bottom>t.bottom)&&(e.left>=t.left&&e.left<=t.right||e.right<=t.right&&e.right>=t.left||e.left<t.left&&e.right>t.right))(e,t),c=l?ve(e.left,e.right,t.width,n):0,d=l?ve(e.top,e.bottom,t.height,i):0;return i>o&&d>o*s||n>a&&c>a*s||d*c/(n*i)>r})(t,r,this.config.significantElementSizePercentage,this.config.significantElementSizeForBiggerThanViewportPercentage)?this.visibleElementsByIntersectionObserver.has(e)||(this.visibleElementsByIntersectionObserver.add(e),this.notVisibleElements.delete(e),R(e,"inViewport")):(this.markPreviouslyVisibleElementAsHidden(e),this.notVisibleElements.add(e))})),this.resetCurrentlyVisibleElementsOnTimeout()},this.scrollHandler=()=>{this.state.isScrolling||(this.state.scrollStartTime=(new Date).getTime(),this.state.isScrolling=!0),clearTimeout(this.markCurrentlyVisibleElementsAsSeenOnTimeout()),this.scrollEndHandler()},this.addBox=e=>{null!==e&&-1===this.boxes.indexOf(e)&&(this.boxes.push(e),this.observer.observe(e))},this.isBoxInViewport=e=>this.visibleElementsByIntersectionObserver.has(e),this.markBoxAsRendered=e=>(y(e,pe)&&this.addBox(e),ge(e).forEach(this.addBox),Promise.resolve()),this.markBoxAsVisible=(e,t=!1)=>{if(this.addBox(e),t){const{timeoutValue:t}=this.config;fe(e,t,t)}},this.recursivelyMarkBoxAsVisible=(e,t=!1)=>{this.markBoxAsVisible(e,t),ge(e).forEach((e=>this.markBoxAsVisible(e,t)))},this.removeBox=(e,t)=>{null!==e&&(this.markPreviouslyVisibleElementAsHidden(e),((e,t=!0)=>{t&&he.delete(e),ue.delete(e)})(e,t),this.boxes=this.boxes.filter((t=>t!==e)),this.visibleElements=this.visibleElements.filter((t=>t!==e)),this.observer.unobserve(e))},this.markBoxAsHidden=e=>{this.removeBox(e,!1),this.resetCurrentlyVisibleElementsOnTimeout()},this.unmountNode=e=>{me(e).forEach(this.removeBox)},this.recursivelyMarkBoxAsHidden=e=>{this.markBoxAsHidden(e),ge(e).forEach(this.markBoxAsHidden)},this.trackBoxScroll=e=>{W(e,"scroll",this.scrollHandler)},this.targetWindow=e,this.document=e.document,this.config={timeoutValue:n,debounceTimeoutValue:i,significantElementSizePercentage:r,significantElementSizeForBiggerThanViewportPercentage:s},this.resetState(),this.boxes=t.length?t:ge(e.document),this.visibleElements=[],this.visibleElementsByIntersectionObserver=new Set,this.notVisibleElements=new Set,this.observer=new e.IntersectionObserver(this.intersectionHandler,{threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}),this.scrollEndHandler=O(this.resetCurrentlyVisibleElementsAfterScroll,i),this.resetCurrentlyVisibleElementsOnTimeout=function(e,t,r){let s;return function(...r){const n=this;return new Promise((i=>{clearTimeout(s),s=setTimeout((()=>{s=null,i(e.apply(n,r))}),t)}))}}(this.resetCurrentlyVisibleElements.bind(this),i),this.markCurrentlyVisibleElementsAsSeenOnTimeout=O(this.markCurrentlyVisibleElementsAsSeen,n)}resetState(){const e=U();this.state={isScrolling:!1,scrollStartTime:e,counterStartTime:e}}markPreviouslyVisibleElementsAsSeen(){const e=U();this.visibleElements.forEach((t=>{fe(t,e-this.state.counterStartTime,this.config.timeoutValue)}))}markPreviouslyVisibleElementsAsSeenAfterScroll(){this.visibleElements.forEach((e=>{fe(e,this.state.scrollStartTime-this.state.counterStartTime,this.config.timeoutValue)}))}resetCurrentlyVisibleElements(){this.markPreviouslyVisibleElementsAsSeen(),this.visibleElements=[],this.visibleElementsByIntersectionObserver.forEach((e=>this.visibleElements.push(e))),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}resetCurrentlyVisibleElementsAfterScroll(){this.markPreviouslyVisibleElementsAsSeenAfterScroll(),this.notVisibleElements.forEach((e=>{this.observer.unobserve(e),this.observer.observe(e)})),this.markCurrentlyVisibleElementsAsSeenOnTimeout(),this.resetState()}initialize(){W(this.targetWindow,"scroll",this.scrollHandler),this.boxes.forEach((e=>this.observer.observe(e)))}createAPI(){return{markBoxAsRendered:this.markBoxAsRendered,markBoxAsVisible:this.markBoxAsVisible,recursivelyMarkBoxAsVisible:this.recursivelyMarkBoxAsVisible,markBoxAsHidden:this.markBoxAsHidden,recursivelyMarkBoxAsHidden:this.recursivelyMarkBoxAsHidden,trackBoxScroll:this.trackBoxScroll,isBoxInViewport:this.isBoxInViewport}}}function qe([e,t]){return null==t||0===t.length?"":Array.isArray(t)?t.map((t=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&"):`${encodeURIComponent(e)}=${encodeURIComponent(t)}`}function Qe(e,t=[]){const r=Object.fromEntries(t.map((({name:e,value:t})=>[e,t]))),s=((e,t)=>{const r=(e=>e.replace("?","").split("&").filter(Boolean).map((e=>e.split("="))).reduce(((e,[t,r])=>(e[t]?e[t].push(r):e[t]=[r],e)),{}))(e);return Object.entries(r).filter((([e])=>{const r=e.replace(/\+/g,"%20");return!Object.keys(t).map((e=>encodeURIComponent(e))).includes(r)})).map((([e,t])=>t.map((t=>`${e}=${null!=t?t:""}`)).join("&")))})(e,r),n=(e=>Object.entries(e).map(qe).filter(Boolean))(r),i=[...s,...n].join("&");return i?"?"+i:""}class Ge{constructor({targetWindow:e,opboxWebClient:t,rawDataListenersRegistry:r,reportError:s}){this.navigateRelative=(e,{persistHash:t=!1,shouldReplaceState:r=!1}={})=>{const s=new URL(this.location),n=this.location.search;t||(s.hash="");const i=Qe(n,null==e?void 0:e.filter((e=>!e.fetchUrlOnly))),o=Qe(n,e),a=s.pathname+i+s.hash;return o!==this.lastFetchParams&&this.fetch(o),i!==n&&(this.changeUrl(a,r),this.changeCallbacks.forEach((e=>e())),this.targetWindow.performance.mark("clientSideNavigationStart")),a},this.refreshPage=()=>{this.fetch(this.location.search)},this.changeState=({queryParameters:e,hash:t,shouldChangeHistory:r})=>{if(!e&&!m(t))return this.reportError(Error("New parameters (array) or hash (string) required")),null;const s=new URL(this.location),n=null==e?void 0:e.filter((e=>!e.fetchUrlOnly)),i=this.location.search;s.search=Qe(i,n),m(t)&&(s.hash=t);const o=this.location.pathname+s.search+s.hash;return s.href!==this.location.href&&(this.changeUrl(o,!r),this.changeStateCallbacks.forEach((e=>e()))),o},this.registerChangeCallback=e=>{this.registerCallback(e,this.changeCallbacks)},this.registerChangeStateCallback=e=>{this.registerCallback(e,this.changeStateCallbacks)},this.removeChangeCallback=e=>{this.changeCallbacks=this.removeCallback(e,this.changeCallbacks)},this.removeChangeStateCallback=e=>{this.changeStateCallbacks=this.removeCallback(e,this.changeStateCallbacks)},this.targetWindow=e,this.location=e.location,this.opboxWebClient=t,this.rawDataListenersRegistry=r,this.reportError=s,this.lastFetchParams=this.location.search,this.changeCallbacks=[],this.changeStateCallbacks=[]}initialize(){this.targetWindow.addEventListener("popstate",(e=>this.handlePopState(e)))}changeUrl(e,t=!1){t?this.targetWindow.history.replaceState("","",e):this.targetWindow.history.pushState("","",e)}handlePopState(e){const t=e.target.location.search;this.lastFetchParams!==t&&this.refreshPage()}fetch(e){const t=this.location.pathname+e;this.lastFetchParams=e,this.rawDataListenersRegistry.triggerProgressListener(),this.opboxWebClient.getPageData(t).then((e=>this.rawDataListenersRegistry.triggerChangeListener(e))).catch((e=>{e.message!==_&&this.reportError(Error(`Error while fetching page data for path ${t}: ${e.message}`))}))}registerCallback(e,t=[]){b(e)?t.push(e):this.reportError(Error(`First argument must be a function but got "${u(e)}"`))}removeCallback(e,t=[]){if(b(e)){const r=t.filter((t=>t!==e));return r.length===t.length&&this.reportError(Error("Trying to remove unregistered callback")),r}return this.reportError(Error(`First argument must be a function but got "${u(e)}"`)),t}createAPI(){return{registerChangeCallback:this.registerChangeCallback,registerChangeStateCallback:this.registerChangeStateCallback,removeChangeCallback:this.removeChangeCallback,removeChangeStateCallback:this.removeChangeStateCallback,changeState:this.changeState}}}const Je=500,Ye="opboxAnimationTimerInterval",Ke={easeInOutQuart(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}};function Xe(e,t,r,s,{duration:n=Je,onFinish:i}={}){if(!b(s))return null;const o=U(),a=r-t;let l=t,c=!1;const d=()=>{const h=U()-o;if(c||h>=n)l===r||s(r),b(i)&&i(),c=!1;else{const r=Math.min(h/n,1);l=Ke.easeInOutQuart(r)*a+t,s(l),e.requestAnimationFrame(d)}};return d(),{stop(){c=!0}}}function Ze(e,t=0,{duration:r=Je}={}){const s=e.pageYOffset,n=Math.max(0,t),i=e.document.body.scrollHeight;function o(){e[Ye]&&b(e[Ye].stop)&&(e[Ye].stop(),e[Ye]=null)}o(),e[Ye]=Xe(e,s,t,(t=>{e.scrollTo(0,Math.round(t)),(t=>{const r=t===n||t===n,s=e.innerHeight+t>=i;return r||s})(t)&&o()}),{duration:r})}class et{constructor(){this.status=1,this.promise=new Promise((e=>{this.resolve=e}))}registerImplementation(e){this.status=2,this.resolve(e)}}class tt{constructor({reportError:e,allowedPlugins:t=[]}={}){this.addPluginToRegistry=({name:e})=>{this.isPluginAvailable(e)||this.pluginsRegistry.set(e,new et)},this.register=(e,t)=>{if(!e)return void this.reportRegistrationError('First argument "config" should be defined');const{name:r}=e;if(!m(r))return void this.reportRegistrationError('Property "name" should be a string');if(!r)return void this.reportRegistrationError('Property "name" should be a non-empty string');if(!t)return void this.reportRegistrationError('Second argument "implementation" is required');if(!this.isPluginAvailable(r))return void this.reportRegistrationError(`Plugin "${r}" is not allowed to register on this page`);const s=this.pluginsRegistry.get(r);2!==s.status?s.registerImplementation(t):this.reportRegistrationError(`Plugin "${r}" is already registered on page`,!0)},this.getPlugin=e=>this.isPluginAvailable(e)?this.pluginsRegistry.get(e).promise:Promise.reject(Error(`Plugin "${e}" is unavailable`)),this.updateRegistry=(e=[])=>{e.forEach(this.addPluginToRegistry)},this.reportError=e,this.pluginsRegistry=new Map,this.boundUpdateRegistry=this.updateRegistry,this.updateRegistry(t)}isPluginAvailable(e){return this.pluginsRegistry.has(e)}reportRegistrationError(e,t=!1){const r=Error("Plugin registration error. "+e);t?console.error(r):this.reportError(r)}createAPI(){return{register:this.register,get:this.getPlugin}}}function rt(e,t){return r=>{if(!e.has(r))return Promise.reject(Error(`Service ${r} is not registered`));const s=e.get(r);return s.fetchIfNotFetched(t),s.promise}}class st{constructor({prototypeName:e,servicesRegistry:t,targetWindow:r}){this.services=new Map,t.forEach(((t,r)=>{t.components.some((t=>t===e))&&this.services.set(r,t)})),this.get=rt(this.services,r)}}const nt=["tags"],it=(e,t)=>{const{document:{documentElement:{clientWidth:r,clientHeight:s}},navigator:{userAgent:n}}=e,{downlink:i}=(({navigator:{connection:e,mozConnection:t,webkitConnection:r}})=>e||t||r||{})(e),o=`${r}x${s}`,a=!f(t);return Object.assign(Object.assign({device:{viewport:o,ua:n}},a&&{other:t}),i&&{connection:{speed:i}})},ot=e=>(t,r)=>{if(0===t.status)return;const s=r||{},{tags:n}=s,i=Le(s,nt);console.error("Error: "+t.message),e.opbox.plugin.get("sentry").then((r=>r.captureException(t,Object.assign({contexts:it(e,i)},!f(n)&&{tags:n})))).catch(N)};function at(e,t){return t.filter((t=>{return!e.find((r=t,e=>{if(r.url)return[e.url,e.href,e.src].includes(r.url);if(r.code){const{attributes:t={}}=r,s=!i(t).some((r=>t[r]!==E(e.node,r)));return r.code===e.code&&s}return!1}));var r}))}function lt(e,t,r){if(!t.length)return Promise.resolve();const s=(e=>a(e.document.getElementsByTagName("script"),(e=>({src:e.src,code:e.innerHTML,nonce:e.nonce,node:e}))))(e),n=(e=>(e.find((({nonce:e})=>!!e))||{}).nonce)(s),i=at(s,t),[l,c]=i.reduce(((e,t)=>(e[t.async?0:1].push(t),e)),[[],[]]),d=((e,t,r=N)=>{const{document:s}=e,n=ot(e),i=F(e);return({url:e,code:a,attributes:l,type:c})=>e||a?new Promise((d=>{const h=!e&&!!a,u="module"===c,p=S(s,"script");let m,g=!1;const b=t=>{d(),t.message||(t.message="Error while loading script: "+e),n(t),L(p,"error",b)},f=()=>{d(),L(p,"error",b),L(p,"load",f)};if(!u||i){if(l){if(l.nomodule&&i)return void d();o(l).forEach((([e,t])=>{"data-serialize-box-id"!==e&&"data-serialize-box-name"!==e||(g=!0,m=C(s,`[${e}="${t}"]`)),p.setAttribute(e,t)}))}t&&p.setAttribute("nonce",t),c&&(p.type=c),h?(p.innerHTML=a,d()):(p.src=e,W(p,"load",f),W(p,"error",b)),m?m.parentNode.replaceChild(p,m):s.head.appendChild(p),g&&r()}else d()})):Promise.resolve()})(e,n,r),h=async(e=[])=>{if(!e.length)return Promise.resolve();const[t,...r]=e;return await d(t),h(r)};return h(c).then((()=>Promise.all(l.map(d))))}class ct{constructor({assetUrls:e,components:t,reportError:r}){this.assetUrls=e,this.components=t,this.reportError=r,this.implementation=null,this.status=0,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}update(e){this.components=((e,t)=>t.reduce(((e,t)=>e.find((e=>e===t))?e:e.concat([t])),e))(this.components,e)}registerImplementation(e){try{this.implementation=new e,this.status=2,this.resolve(this.implementation)}catch(t){this.handleError(Error("Error while trying to register service implementation: "+t.message))}}fetchIfNotFetched(e){if(0===this.status){this.status=1;const{module:t,nomodule:r}=this.assetUrls;lt(e,[F(e)?{url:t,type:"module"}:{url:r}]).catch((e=>{this.handleError(Error("Error while trying to inject service scripts: "+(e?e.message:"")))}))}}handleError(e){this.reportError(e),this.status=2,this.reject()}}class dt{constructor({targetWindow:e,reportError:t}){this.update=e=>{e.forEach((([e,{nomodule:t,module:r,components:s}])=>{this.servicesRegistry.has(e)?this.servicesRegistry.get(e).update(s):this.setServiceToRegistry(e,{nomodule:t,module:r},s)}))},this.register=({serviceName:e},t)=>{this.servicesRegistry.get(e).registerImplementation(t)},this.targetWindow=e,this.reportError=t,this.servicesRegistry=new Map;const r=C(e.document,'script[data-config="services"]');if(r)try{c(H(r)).forEach((([e,{nomodule:t,module:r,components:s}])=>{this.setServiceToRegistry(e,{nomodule:t,module:r},s)}))}catch(s){t(s)}this.dangerouslyGet=rt(this.servicesRegistry,e)}getServicesForComponent(e){return new st({prototypeName:e,servicesRegistry:this.servicesRegistry,targetWindow:this.targetWindow})}setServiceToRegistry(e,t,r){this.servicesRegistry.set(e,new ct({assetUrls:t,components:r,reportError:this.reportError}))}createAPI(){return{register:this.register,__dangerouslyGet__:this.dangerouslyGet.bind(this)}}}function ht(e,t,r,...s){if(b(e)&&b(t)){if(!e.__queue__)return;n=e.__queue__,o=t,n.forEach((({args:e,reject:t,resolve:r})=>{const s=((e,t)=>{try{return e(...t)}catch(r){return void console.error(r)}})(o,e);s&&b(s.then)&&b(r)&&b(t)&&s.then(r,t)})),r(t,...s)}else p(e)&&p(t)&&i(e).forEach((n=>{ht(e[n],t[n],r,...s.concat(n))}));var n,o}class ut{constructor({localStorage:e,reportError:t,ttlMs:r=2592e6,key:s="opbox.preferences",timeProvider:n=U}){this.savePreferences=e=>{const t=this.loadPreferences(),r=this.timeProvider(),s=e.reduce(D((({name:e,value:t})=>({[e]:{value:t,timestamp:r}}))),t);this.writeToStorage(s)},this.writeToStorage=e=>{try{this.storage.setItem(this.key,d(e))}catch(t){this.reportError(Error("Error while writing data to storage. Error message: "+t.message))}},this.loadPreferences=()=>{try{return c(this.storage.getItem(this.key))||{}}catch(e){return this.reportError(Error("Error while loading data from storage. Error message: "+e.message)),{}}},this.cleanupPreferences=()=>{const e=this.loadPreferences(),t=this.timeProvider(),r=o(e).reduce(D((([e,r])=>r.timestamp+this.ttlMs>t?{[e]:r}:{})),{});this.writeToStorage(r)},this.storage=e,this.ttlMs=r,this.key=s,this.timeProvider=n,this.reportError=t}}class pt{savePreferences(){}loadPreferences(){return{}}cleanupPreferences(){}}const mt=["Content-Type"],gt="/preferences",bt="illegal argument type provided as preferences",ft={withCredentials:!0,headers:{"Content-Type":"application/vnd.allegro.internal.v1+json",Accept:"application/vnd.allegro.internal.v1+json"}};class vt{constructor({edgeClient:e,localStorage:t,ttlMs:r,reportError:s}){this.setPreference=(e,t)=>{const r={name:e,value:t};return this.storage.savePreferences([r]),this.edgeClient.post(gt,r,ft)},this.getPreference=(e,t)=>m(e)||e instanceof String?this.getPreferences({[e]:t}).then((t=>t[e])):Promise.reject(Error("illegal argument type provided as preference name")),this.setPreferences=e=>{if(!p(e))return Promise.reject(Error(bt));const t=o(e).map((([e,t])=>({name:e,value:t})));return this.storage.savePreferences(t),this.edgeClient.post("/preferences/multi",d(t),ft)},this.getPreferences=e=>{if(!p(e))return Promise.reject(Error(bt));const t=i(e).join(","),r=`${gt}?name=${t}`,{withCredentials:s,headers:{"Content-Type":n}}=ft,o=Le(ft.headers,mt);return this.edgeClient.get(r,{withCredentials:s,headers:o}).then((({data:{preferences:e}})=>(this.storage.savePreferences(e),e.reduce(D((({name:e,value:t})=>({[e]:t}))),{})))).catch((()=>this.getPreferencesFromLocalStorageOrDefaults(e)))},this.getPreferencesFromLocalStorageOrDefaults=e=>{this.storage.cleanupPreferences();const t=this.storage.loadPreferences();return o(e).reduce(D((([e,r])=>({[e]:e in t?t[e].value:r}))),{})},this.edgeClient=e,this.storage=(e=>{try{const t="test_preferences_storage";return e.setItem(t,t),e.getItem(t),e.removeItem(t),!0}catch(t){return!1}})(t)?new ut({localStorage:t,ttlMs:r,reportError:s}):new pt}createAPI(){return{set:this.setPreference,get:this.getPreference,setMany:this.setPreferences,getMany:this.getPreferences}}}var Ct=["assets","spinner","button","link","badge","brand","bubble","card","chart","desk","divider","heading","hint","icon","indicator","input","list","timeline","timer","marker","notification","placeholder","price","progress","table","dropdown","breadcrumb","accordion","carousel","chip","choice","dialog","field","image-tile","input-group","message","modal","pagination","range","select","sheet","slider","soap","stepper","switch","tabs","typography","color","grid","board","calendar","datepicker","attachment","article","navigation-tiles","pin","player-video","tip","align","border","box-sizing","display","flex","height","margin","outline","padding","position","transition","utils","visibility","white-space","width","zindex","core"];function yt(e){return v(e,'link[type="text/css"],style',(e=>({href:e.href,code:e.innerHTML,media:e.media,node:e,isMetrum:I(e.href)}))).filter((({href:e,code:t})=>e||t))}function Et(e,t,r){const s=[],n=C(e,r.selectors.bundledStylesMap);if(!n)return s;try{return c(H(n))}catch(i){return t(Error("Bundled styles map: invalid JSON")),s}}const wt=["crossOrigin"];var xt=(e,{href:t,media:r,crossOrigin:s},n)=>{const i=(({document:e},t,{referenceNode:r=null}={})=>s=>{if(f(s))return null;M(s,((e,t)=>!(t||wt.includes(e))));const n=S(e,"link",s,{rel:t});return r?((e,t)=>{e.insertAdjacentElement("afterend",t)})(r,n):e.head.appendChild(n),n})(e,"stylesheet",{referenceNode:n})(Object.assign({type:"text/css",href:t,media:r},!g(s)&&{crossOrigin:s}));return new Promise(((e,t)=>{W(i,"error",t),W(i,"load",e)}))};const Pt=e=>({href:t})=>t.includes(e+"/"),kt=(e,t,r)=>{const s=e.filter((({isMetrum:e})=>e)),n=t.slice(0,t.indexOf(r)).reverse().find((e=>s.find(Pt(e)))),i=n?s.find(Pt(n)).node:null;return!i&&s.length?s[0].node.previousElementSibling:!i&&e.length?e[0].node.previousElementSibling:i};function St(e,t){return e.findIndex((e=>e.selectorText===t))}function It(e,t,r){const s=e.document.createDocumentFragment(),n=r.map((({url:r,code:n,media:i})=>{if(I(r))return((e,t,{href:r,media:s},n)=>{const i=A(r);return n.includes(i)?xt(e,{href:r,media:s,crossOrigin:""},kt(t,n,i)):Promise.resolve()})(e,t,{href:r,media:i},Ct);if(r){const t=S(e.document,"link",Object.assign({type:"text/css",rel:"stylesheet",crossOrigin:"",href:r},i?{media:i}:{}));return s.appendChild(t),new Promise(((e,r)=>{t.addEventListener("error",(()=>r(Error("Loading external styles failed")))),t.addEventListener("load",e)}))}return n?(s.appendChild(S(e.document,"style",{textContent:n})),Promise.resolve()):Promise.reject(Error("Given styles have empty code/href"))}));return e.document.head.appendChild(s),Promise.all(n)}let At;function Nt({targetWindow:e,webResponse:t,config:r}){const{svgColorMatrixFilters:s="",assets:{styles:n=[]}={}}=t;return(({document:e},t)=>{if(!t)return;const r=C(e,"#svg-color-matrix-filters"),s=C(S(e,"div",{innerHTML:t}),"svg");r?v(s,"filter",(e=>{C(r,"#"+E(e,"id"))||r.appendChild(e)})):e.body.insertBefore(s,e.body.firstChild)})(e,s),((e,t,r)=>{if(!t.length)return Promise.resolve();const s=[...yt(e.document),...Et(e.document,ot(e),r)],n=at(s,t);At=At&&!At.forceRefresh?At:((e,{cssBundle:{isEnabled:t,emptyRule:r}},s)=>{const n=t?(e=>a(e.document.styleSheets).find((({ownerNode:e})=>e&&y(e,"data-metrum-bundle"))))(e):null;let i=[];const o=e=>r.pattern.replace(r.replacementPart,e);return{isEnabled:t,inject(r){if(!t)return Promise.resolve();const[l,c]=((e,t)=>t.reduce((([t,r],s)=>(e.includes(s)||r.push(s),t.push(s),[t,r])),[[],[]]))(i,r);return i=l,c.length?((e,t)=>{const r=e.createDocumentFragment(),s=t.map((t=>S(e,"link",{type:"text/css",rel:"stylesheet",crossOrigin:"",href:t,media:"not all"}))),n=s.map((e=>new Promise(((t,s)=>{W(e,"load",(()=>{t(e.sheet)})),W(e,"error",s),r.appendChild(e)})))),i=()=>{s.forEach((e=>{e.remove()}))};return e.head.appendChild(r),Promise.all(n).then((e=>[e,i]))})(e.document,c).then((([e,t])=>{e.forEach((e=>{const t=a(n.cssRules),r=t.length;if(((e,t)=>t.cssRules.length>0&&e.findIndex((e=>e.cssText===t.cssRules[0].cssText))>-1)(t,e))return;const i=A(e.href),l=s.indexOf(i),c=-1!==l?s.slice(l):[];let d=r;for(let s=0;s<c.length;s+=1){const e=St(t,o(c[s]));if(e>0){d=e;break}}const h=a(e.cssRules);h.unshift({cssText:o(i)+"{}"});for(let s=0;s<h.length;s+=1)n.insertRule(h[s].cssText,d+s)})),t()})):Promise.resolve()}}})(e,r,Ct);const{inject:i,isEnabled:o}=At,[l,c]=n.reduce(((e,t)=>I(t.url)&&o?(e[0].push(t.url),e):(e[1].push(t),e)),[[],[]]);return Promise.all([It(e,s,c),i(l)])})(e,n,r)}function Ot({targetWindow:e,webResponse:t,lazyScriptsManager:r,updateSerializedPropsCollectionCallback:s}){const{assets:{scripts:n=[]}={}}=t,[i,o]=n.reduce(((e,t)=>(t.lazyDownload?e[0].push(t):e[1].push(t),e)),[[],[]]);return lt(e,o,s).then((()=>r.handleSubtreeAssets(i)))}var Rt=({config:e,targetWindow:t,unmountNodeCallback:r,mountNodeCallback:s,updateServicesCallback:n,updateAllowedPluginsCallback:i,updateSerializedPropsCollectionCallback:o,updateComponentNodesCollectionCallback:a,updateDebugDataCallback:l,injectStylesAndFilters:c=Nt,injectScripts:d=Ot,lazyScriptsManager:h})=>{const{document:u}=t;function p(e){return C(u,`[data-box-id="${e}"]`)}return({boxId:m,data:g={},isPlaceholder:b})=>{const{htmlString:f="",servicesConfig:v=[],allowedPlugins:y=[],debugData:E}=g;return n(v),i(y),c({targetWindow:t,webResponse:g,config:e}).then((()=>{const e=b?(e=>C(u,`[data-placeholder-for="${e}"]`))(m):p(m);if(r(e),!f)return e.parentNode.removeChild(e),!1;const t=S(u,"div",{innerHTML:f});return e.parentNode.replaceChild(t.firstElementChild,e),!0})).then((e=>{a(),d({targetWindow:t,webResponse:g,lazyScriptsManager:h,updateSerializedPropsCollectionCallback:o}).then((()=>e&&s(p(m))))})).then((()=>{E&&l(E)}))}},jt=({config:e,targetWindow:t,unmountNodeCallback:s,mountNodeCallback:n,updateServicesCallback:i,updateAllowedPluginsCallback:o,updateSerializedPropsCollectionCallback:a,updateComponentNodesCollectionCallback:l,updateDebugDataCallback:c,injectStylesAndFilters:d=Nt,injectScripts:h=Ot,lazyScriptsManager:u,setFragmentAnalyticsContext:p,deleteFragmentAnalyticsContext:m})=>{const{document:g}=t;function b(e){return C(g,`[${r}="${e}"]`)}function f(e,t,s){const n=S(g,"div",{innerHTML:t});return n.setAttribute(r,e),s&&p(n,s),n}return({pathname:r,data:p={}})=>{const{htmlString:v="",servicesConfig:C=[],allowedPlugins:y=[],analyticsContext:E,debugData:w}=p;return i(C),o(y),d({targetWindow:t,webResponse:p,config:e}).then((()=>{const e=b(r);if(!e&&v){const e=f(r,v,E);return g.body.appendChild(e),!0}if(e){if(s(e),m(e),!v)return e.parentNode.removeChild(e),!1;const t=f(r,v,E);return e.parentNode.replaceChild(t,e),!0}return!1})).then((e=>{l(),h({targetWindow:t,webResponse:p,lazyScriptsManager:u,updateSerializedPropsCollectionCallback:a}).then((()=>e&&n(b(r))))})).then((()=>{w&&c(w,!0)}))}};const Vt=(e,t="")=>e+t;class Mt{constructor(e,t){this.observerEntriesHandler=e=>{e.forEach((e=>{if(!e.isIntersecting)return;const{target:{dataset:{civ:t,prototypeId:r}}}=e,s=this.getDependencyMapEntry(r,t),n=Vt(r,t);this.isDownloaded(n)||(this.markAsDownloaded(n),this.unobserveAllUnderKey(n),s?lt(this.targetWindow,s.scripts):this.reportError(Error(`Lazy scripts: Entry not found for "${r}@${t}"`)))}))},this.onPrototypeRegistered=(e,t)=>{const r=Vt(e,t),s=this.unhandledClicks[r];this.registered.push(r),s&&this.reportError(Error(`Lazy scripts: unhandled click(s) registered for "${e}@${t}" before its script was downloaded.`),{unhandledClicksCount:s})},this.targetWindow=e,this.observedElements={},this.downloaded=[],this.registered=[],this.dependencyMapCache=[],this.observer=null,this.reportError=ot(e),this.componentNodesFinder=t,this.unhandledClicks={}}createObserverInstance(){this.observer||(this.observer=new this.targetWindow.IntersectionObserver(this.observerEntriesHandler,{rootMargin:"800px",threshold:0}))}markAsDownloaded(e){this.downloaded.push(e)}isDownloaded(e){return this.downloaded.includes(e)}markAsRegistered(e){this.registered.push(e)}isRegistered(e){return this.registered.includes(e)}observeElement(e,t){this.observedElements[t]=[...this.observedElements[t]||[],e],this.observer.observe(e)}unobserveAllUnderKey(e){this.observedElements[e].forEach((e=>this.observer.unobserve(e)))}getDependencyMapEntry(e,t=""){return this.dependencyMapCache.find((({prototypeId:r,clientImplementationVersion:s=""})=>r===e&&s===t))}addDependencies(e){e.forEach((e=>{const{prototypeId:t,clientImplementationVersion:r}=e;this.getDependencyMapEntry(t,r)||this.dependencyMapCache.push(e)}))}observeComponents(e){e.forEach((e=>{const{prototypeId:t,clientImplementationVersion:r}=e,s=this.componentNodesFinder.find(t,r);if(!s.length)return void this.reportError(Error(`Lazy scripts: DOM reference not found for "${t}@${r}"`));const n=Vt(t,r);s.forEach((e=>{this.observeElement(e,n),this.watchForUnhandledClicks(e,n)}))}))}filterDownloadedScripts(e){return e.filter((({prototypeId:e,clientImplementationVersion:t})=>!this.isDownloaded(Vt(e,t))))}watchForUnhandledClicks(e,t){W(e,"click",(()=>{this.isRegistered(t)||(this.unhandledClicks[t]=(this.unhandledClicks[t]||0)+1)}))}handleSSRAssets(){const{document:e}=this.targetWindow;$(e,(()=>{this.dependencyMapCache=((e,t)=>{const r=C(e,'script[data-config="lazy-scripts-map"]'),s=[];if(!r)return s;try{return c(H(r))}catch(n){return t(Error("Lazy scripts: incorrect dependency map JSON")),s}})(e,this.reportError),f(this.dependencyMapCache)||(this.createObserverInstance(),this.observeComponents(this.dependencyMapCache))}))}handleSubtreeAssets(e){const t=this.filterDownloadedScripts(e);if(f(t))return;const r=(e=>n(e.reduce(((e,t)=>{const{prototypeId:r,clientImplementationVersion:s}=t,n=Vt(r,s),i=e[n];return i?(i.scripts.push(t),e):(e[n]={prototypeId:r,clientImplementationVersion:s,scripts:[t]},e)}),{})))(t);this.addDependencies(r),this.createObserverInstance(),z((()=>this.observeComponents(r)))}}class Tt{constructor(e){this.document=e.document,this.collection=[],this.updateNodesCollection()}updateNodesCollection(){this.collection=v(this.document,"div[data-prototype-id]")}find(e,t){return t?this.collection.filter((r=>w(r)===e&&k(r)===t)):this.collection.filter((t=>w(t)===e))}}class Bt{constructor(){this.listeners=new Map}addEventListener(e,t){const r=this.listeners.get(e)||new Set;r.add(t),this.listeners.set(e,r)}removeEventListener(e,t){const r=this.listeners.get(e);r&&(r.delete(t),this.listeners.set(e,r))}trigger(e){const t=this.listeners.get(e.type);t&&t.forEach((t=>t(e)))}}const Dt=(e,t,r)=>e.map((e=>Object.assign(Object.assign({},e),{},{updatedAt:r,rawParameters:t.resolveAll(e.rawParameters),slots:e.slots.map((e=>Object.assign(Object.assign({},e),{},{boxes:Dt(e.boxes,t,r)})))}))),Wt=(e,t,r)=>e.map((e=>{const s=t.get(e.boxId)||t.get(e.name);return Object.assign(Object.assign({},e),{},{updatedAt:s?r:e.updatedAt,rawParameters:s||e.rawParameters,slots:e.slots.map((e=>Object.assign(Object.assign({},e),{},{boxes:Wt(e.boxes,t,r)})))})})),Lt=(e,t)=>{let r=!1;const s=[...e];for(let n=0;n<s.length;n+=1){const e=s[n];if(e.placeholderFor===t.boxId){r=!0,s[n]=t;break}if(e.slots)for(let i=0;i<e.slots.length;i+=1){const o=e.slots[i],{boxes:a,hasReplaced:l}=Lt(o.boxes,t);if(l){r=!0,e.slots[i].boxes=a,s[n]=e;break}}}return{boxes:s,hasReplaced:r}};class Ut{constructor({targetWindow:e,reportError:t}){this.initialize=()=>{const e=this.window.document.getElementById("page-debug-data");if(!e)return void this.disableCallbackQueueing();let t=null;try{t=c(H(e))}catch(r){return this.disableCallbackQueueing(),void this.reportError(Error("Failed to parse page debug data."))}this.updateData(t,!0),this.initialized=!0,this.eventBus.trigger(new CustomEvent("init",{detail:this.getData()}));for(const s of this.queuedStructureChanges)s(),this.triggerUpdateEvent();this.clearQueuedCallbacks()},this.updateData=(e,t=!1)=>{if(!e)return;const r=e.pageDefinition.dataSources.reduce(((e,t)=>Object.assign(Object.assign({},e),{},{[t.name]:t})),{}),s=new ee(r);if(e.boxes.length>0){const r=Date.now(),n=Dt(e.boxes,s,r);if(t)this.boxes.push(...n);else{const[e]=n,{boxes:t}=Lt(this.boxes,e);this.boxes=t}}if(e.plugins.length>0){const t=((e,t)=>e.map((e=>Object.assign(Object.assign({},e),{},{parameters:t.resolveAll(e.parameters)}))))(e.plugins,s);for(const e of t){const t=this.plugins.get(e.name);t?this.plugins.set(e.name,Object.assign(Object.assign({},t),{},{parameters:e.parameters})):this.plugins.set(e.name,e)}}for(const n of e.services)this.services.has(n.name)||this.services.set(n.name,n);this.initialized||(this.appVersion=e.appVersion,this.pageDefinition=e.pageDefinition,this.appDependencies=e.appDependencies)},this.onSubtree=(e,t=!1)=>{this.execOrQueueStructureChange((()=>{this.updateData(e,t)}))},this.onRawDataChange=e=>{this.execOrQueueStructureChange((()=>{this.boxes=Wt(this.boxes,new Map(o(e.resolvedBoxes)),Date.now())}))},this.execOrQueueStructureChange=e=>{this.initialized?(e(),this.triggerUpdateEvent()):this.allowCallbackQueue&&this.queuedStructureChanges.push(e)},this.getData=()=>this.initialized?{appDependencies:this.appDependencies,boxes:this.boxes,plugins:a(this.plugins.values()),services:a(this.services.values()),pageDefinition:this.pageDefinition,appVersion:this.appVersion}:null,this.addEventListener=(e,t)=>{this.eventBus.addEventListener(e,t)},this.removeEventListener=(e,t)=>{this.eventBus.removeEventListener(e,t)},this.disableCallbackQueueing=()=>{this.allowCallbackQueue=!1,this.clearQueuedCallbacks()},this.clearQueuedCallbacks=()=>{this.queuedStructureChanges=[]},this.triggerUpdateEvent=()=>{this.eventBus.trigger(new CustomEvent("update",{detail:this.getData()}))},this.createAPI=()=>({get:this.getData,addListener:this.addEventListener,removeListener:this.removeEventListener}),this.window=e,this.initialized=!1,this.reportError=t,this.eventBus=new Bt,this.boxes=[],this.plugins=new Map,this.services=new Map,this.appVersion="",this.pageDefinition={edgeHost:"",uploadHost:"",parameters:{},metatags:[],skin:"common",trackingData:{},dataSources:[],failedDataSources:[]},this.appDependencies={vendors:[]},this.allowCallbackQueue=!0,this.queuedStructureChanges=[],$(this.window.document,(()=>{((e,t)=>{e.requestAnimationFrame((()=>{z(t)}))})(this.window,(()=>this.initialize()))}))}}const Ft="data-placeholder-for",zt=new class{constructor(e,t,r){this.domReadyHelper=e=>{"loading"===this.document.readyState?$(this.document,e):this.targetWindow.setTimeout(e,0)},this.lazyloadedElement=({target:e}={})=>{const t=E(e,Ft);t&&this.opboxWebClient.render.box({boxId:t,isPlaceholder:!0})},this.attach=()=>{const e=Y(this.targetWindow),t=this.API;var r,s;e&&(ht(e,t,((t,...r)=>((e,t)=>{e[J]=e[J]||{},i(t).forEach((r=>{e[J][r]=t[r]}))})(this.targetWindow,j(e,t,...r)))),r=e,s=i(t).concat("initialized","config"),M(r,(e=>!s.includes(e))),Object.freeze(e)),this.broadcastAPILoadEvent(),W(this.targetWindow,"lazyloaded",this.lazyloadedElement),this.updateInlinePreference(),t.performance.markTimeToInteractive("sc-12453")},this.targetWindow=e,this.document=e.document;const s=(e=>Y(e).config)(e),n=new K({targetWindow:e}),o=new He({targetWindow:e,config:s}),a=new _e({targetWindow:e}),l=ot(e),c=new Ne({targetWindow:e,config:s,cookieMonsterClient:o,boxViewsMarker:a,reportError:l}),d=new dt({targetWindow:e,reportError:l}),h=new Tt(e),p=new Mt(e,h),g=(e=>{const{targetWindow:t,reportError:r,componentNodesFinder:s}=e,n=new De(t,r),i=new Ve(Object.assign(Object.assign({},e),{},{serializedPropsFinder:n}));return{public:Object.assign({init:We(0,s)},i.createPublicAPI()),private:i.createPrivateAPI()}})({targetWindow:e,services:d,reportError:l,componentNodesFinder:h,registerPrototypeCallback:p.onPrototypeRegistered,unmountNodeCallback:a.unmountNode,mountNodeCallback:a.markBoxAsRendered}),b=new tt({reportError:l,allowedPlugins:s.allowedPlugins}),f=new Ut({targetWindow:e,reportError:l}),v={config:s,targetWindow:e,unmountNodeCallback:g.private.unmountNode,mountNodeCallback:g.private.mountNode,updateSerializedPropsCollectionCallback:g.private.updateSerializedPropsCollection,updateComponentNodesCollectionCallback:g.private.updateComponentNodesCollection,updateServicesCallback:d.update,updateAllowedPluginsCallback:b.boundUpdateRegistry,updateDebugDataCallback:f.onSubtree,lazyScriptsManager:p,setFragmentAnalyticsContext:c.setFragmentAnalyticsContext,deleteFragmentAnalyticsContext:c.deleteFragmentAnalyticsContext},y=new ie({config:s,httpClient:t,reportError:l,boxRenderCallback:Rt(v),fragmentRenderCallback:jt(v)}),w=new ae({appContext:n,analytics:c,debugData:f,updateViewIdCallback:y.updateViewId,updateComponentCallback:g.private.updateComponentCallback,beforeUpdateComponentCallback:g.private.beforeUpdateComponentCallback});this.config=s,this.cookieMonsterClient=o,this.boxViewsMarker=a,this.analytics=c,this.services=d,this.componentAPI=g,this.rawDataListenersRegistry=w,this.opboxWebClient=y,this.plugins=b,this.reportError=l,this.lazyScriptsManager=p,this.debugData=f,this.navigation=new Ge({targetWindow:e,opboxWebClient:y,rawDataListenersRegistry:w,reportError:l}),this.edgeClient=new $e({httpClient:r,edgeHost:s.edgeHost,language:s.language}),this.edgeUploadClient=new $e({httpClient:r,edgeHost:s.edgeUploadHost,language:s.language}),this.preferencesClient=new vt({edgeClient:this.edgeClient,localStorage:e.localStorage,reportError:l}),this.uiTools=(e=>{const{document:t}=e,r=e=>m(e)?C(t,`a[name="${e}"]`):null,s=r=>{const s=e.pageYOffset||t.documentElement.scrollTop||0;return r?r.getBoundingClientRect().top+s:null};return{getBoxAnchorNode:r,getTopOffset:s,scrollTo(t,{animate:n=!0}={}){const i={duration:n?500:0};if("number"===u(t))return void Ze(e,t,i);const o=r(t);if(o){const t=s(o);Ze(e,t,i)}},tween:(...t)=>Xe(e,...t)}})(e),p.handleSSRAssets(),c.initialize(),this.navigation.initialize(),a.initialize()}get API(){return{analytics:this.analytics.createAPI(),boxViewsMarker:this.boxViewsMarker.createAPI(),component:this.componentAPI.public,plugin:this.plugins.createAPI(),onData:this.rawDataListenersRegistry.registerListener,changeParams:this.navigation.navigateRelative,refreshPage:this.navigation.refreshPage,tween:this.uiTools.tween,scrollTo:this.uiTools.scrollTo,page:this.opboxWebClient.createAPI(),navigation:this.navigation.createAPI(),edge:this.edgeClient.createAPI(),edgeUpload:this.edgeUploadClient.createAPI(),preferences:this.preferencesClient.createAPI(),onDomReady:this.domReadyHelper,loaded:!0,performance:Y(this.targetWindow).performance,services:this.services.createAPI(),reportError:this.reportError,__internal__debug:this.debugData.createAPI()}}renderBoxForLazyloadedPlaceholders(){a(v(this.document,`[${Ft}].lazyloaded`),(e=>{const t=E(e,Ft);return this.opboxWebClient.render.box({boxId:t,isPlaceholder:!0})}))}updateInlinePreference(){const{config:e,preferencesClient:t}=this;e.cssBundle&&e.cssBundle.shouldInline&&t.setPreference("receivedInline",!0)}broadcastAPILoadEvent(){R(this.targetWindow,"opboxAPILoaded")}run(){this.attach(),this.renderBoxForLazyloadedPlaceholders()}}(window,G(),G());setTimeout((()=>{zt.run()}),0);